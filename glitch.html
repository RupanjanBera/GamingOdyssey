<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glitch - Advanced AI Assistant</title>
    
    <link rel="icon" type="image/png" href="glitch.png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.2/marked.min.js"></script> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css"> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <style>
        /* Using the professional theme's color palette */
        :root {
            --primary-blue: #007AFF;
            --primary-purple: #5856D6;
            --bg-dark-primary: #121212;
            --bg-dark-secondary: #1E1E1E;
            --bg-light-primary: #F9F9F9;
            --bg-light-secondary: #FFFFFF;
            --text-dark-primary: #EAEAEA;
            --text-dark-secondary: #B0B0B0;
            --text-light-primary: #1D1D1F;
            --text-light-secondary: #6E6E73;
            --border-dark: rgba(255, 255, 255, 0.1);
            --border-light: rgba(0, 0, 0, 0.1);
            --shadow-color: rgba(0, 0, 0, 0.2);
            --error-color: #FF3B30;
            --success-color: #34C759;
            --warning-color: #FF9500;
            --font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        body {
            --bg-main: var(--bg-dark-primary);
            --bg-panel: var(--bg-dark-secondary);
            --text-primary: var(--text-dark-primary);
            --text-secondary: var(--text-dark-secondary);
            --border-color: var(--border-dark);
            --user-message-bg: rgba(0, 122, 255, 0.2);
            --ai-message-bg: rgba(255, 255, 255, 0.05);
            --code-bg: #0d1117;
        }

        body.light-mode {
            --bg-main: var(--bg-light-primary);
            --bg-panel: var(--bg-light-secondary);
            --text-primary: var(--text-light-primary);
            --text-secondary: var(--text-light-secondary);
            --border-color: var(--border-light);
            --shadow-color: rgba(0, 0, 0, 0.05);
            --user-message-bg: rgba(0, 122, 255, 0.1);
            --ai-message-bg: rgba(0, 0, 0, 0.03);
            --code-bg: #f6f8fa;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--font-family); scrollbar-width: thin; scrollbar-color: var(--primary-blue) var(--bg-panel); transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; }
        *::-webkit-scrollbar { width: 8px; }
        *::-webkit-scrollbar-track { background: var(--bg-panel); }
        *::-webkit-scrollbar-thumb { background-color: var(--primary-blue); border-radius: 10px; border: 2px solid var(--bg-panel); }
        
        body {
            background-color: var(--bg-main);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        header { display: flex; justify-content: space-between; align-items: center; padding: 15px 5%; background: var(--bg-panel); border-bottom: 1px solid var(--border-color); box-shadow: 0 2px 10px var(--shadow-color); position: sticky; top: 0; z-index: 10; }
        .logo { display: flex; align-items: center; gap: 12px; }
        .logo-icon { width: 40px; height: 40px; border-radius: 8px; object-fit: cover; border: 2px solid var(--primary-blue); }
        .logo-text { font-size: 1.5rem; font-weight: 600; color: var(--text-primary); }
        .header-actions { display: flex; align-items: center; gap: 20px; }
        .api-status { display: flex; align-items: center; gap: 8px; font-size: 0.8rem; color: var(--text-secondary); }
        .status-indicator { width: 8px; height: 8px; border-radius: 50%; background-color: var(--success-color); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .theme-switch-wrapper { display: flex; align-items: center; }
        .theme-switch { display: inline-block; height: 24px; position: relative; width: 44px; }
        .theme-switch input { display:none; }
        .slider { background-color: var(--bg-dark-primary); bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 34px; border: 1px solid var(--border-color); }
        .slider:before { background-color: #fff; bottom: 3px; content: ""; height: 16px; left: 4px; position: absolute; transition: .4s; width: 16px; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-blue); }
        input:checked + .slider:before { transform: translateX(20px); }
        
        .container { display: flex; max-width: 1800px; margin: 0 auto; padding: 20px; gap: 20px; min-height: calc(100vh - 130px); }
        .sidebar { flex: 0 0 300px; background: rgba(var(--bg-panel), 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 12px; padding: 20px; border: 1px solid var(--border-color); box-shadow: 0 4px 15px var(--shadow-color); display: flex; flex-direction: column; gap: 15px; }
        .shine-btn { width: 100%; background: var(--primary-blue); border: none; border-radius: 8px; color: white; padding: 12px 18px; cursor: pointer; transition: all 0.2s ease; font-size: 1rem; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .shine-btn:hover { background: var(--primary-purple); transform: translateY(-2px); }
        .sidebar-heading { font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin: 10px 0 10px 5px; }
        .ai-selector, .mode-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .ai-option, .mode-btn { padding: 10px; background: transparent; border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-secondary); cursor: pointer; transition: all 0.2s ease; text-align: center; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .ai-option:hover, .mode-btn:hover { border-color: var(--primary-blue); color: var(--text-primary); }
        .ai-option.active, .mode-btn.active { background: var(--user-message-bg); border-color: var(--primary-blue); color: var(--primary-blue); font-weight: 500; }
        .chat-history { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; }
        .history-item { padding: 12px 15px; border-radius: 8px; cursor: pointer; transition: background-color 0.2s ease; display: flex; align-items: center; gap: 10px; position: relative; }
        .history-item:hover { background: var(--ai-message-bg); }
        .history-item.active { background: var(--user-message-bg); }
        
        /* UPDATED: Chat area is now transparent to show the galaxy behind it */
        .main-content { flex: 1; display: flex; gap: 20px; }
        .chat-area { flex: 1; display: flex; flex-direction: column; background: transparent; border-radius: 12px; overflow: hidden; border: 1px solid var(--border-color); box-shadow: 0 4px 15px var(--shadow-color); position: relative; }
        
        /* RESTORED: Styles for the galaxy canvas */
        #galaxy-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
        .chat-header, .messages, .input-area { position: relative; z-index: 1; }
        
        /* UPDATED: Glass effect for chat elements */
        .chat-header { padding: 15px 25px; background: rgba(var(--bg-panel), 0.7); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); }
        .messages { flex: 1; padding: 25px; overflow-y: auto; }
        .message { margin-bottom: 20px; padding: 15px 20px; border-radius: 12px; max-width: 90%; position: relative; animation: fadeIn 0.5s ease; line-height: 1.6; background: rgba(var(--bg-panel), 0.5); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border: 1px solid var(--border-color);}
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .user-message { background: var(--user-message-bg); margin-left: auto; }
        .ai-message { background: var(--ai-message-bg); margin-right: auto; }
        .avatar { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; color: #fff; margin-right: 12px; }
        .user-avatar { background: var(--primary-blue); }
        .ai-avatar { background: var(--primary-purple); }
        
        .input-area { padding: 15px; background: rgba(var(--bg-panel), 0.7); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-top: 1px solid var(--border-color); flex-direction: column; gap: 10px; }
        .input-controls { display: flex; gap: 10px; align-items: flex-end; }
        .input-btn { background: transparent; border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-secondary); width: 48px; height: 48px; cursor: pointer; transition: all 0.2s; font-size: 1.1rem; }
        .input-btn:hover, .input-btn.active { border-color: var(--primary-blue); color: var(--primary-blue); }
        .message-input { flex: 1; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-main); color: var(--text-primary); font-size: 1rem; resize: none; outline: none; transition: all 0.2s; min-height: 48px; }
        .message-input:focus { border-color: var(--primary-blue); box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.3); }
        .send-button { width: 48px; height: 48px; background: var(--primary-blue); border: none; border-radius: 8px; color: white; font-size: 1.2rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        .send-button:hover { background: var(--primary-purple); }
        .send-button .loader { width: 18px; height: 18px; border: 2px solid #FFF; border-bottom-color: transparent; border-radius: 50%; display: none; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .stop-generating-btn { margin: 10px auto 0; background: transparent; border: 1px solid var(--warning-color); border-radius: 8px; color: var(--warning-color); padding: 8px 15px; cursor: pointer; transition: all 0.2s; display: none; align-items: center; gap: 5px; }
        .stop-generating-btn:hover { background: var(--warning-color); color: white; }
        
        footer { text-align: center; padding: 20px; font-size: 0.8rem; color: var(--text-secondary); }
        
        #splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background-color: var(--bg-main); display: flex; justify-content: center; align-items: center; z-index: 9999; opacity: 1; visibility: visible; transition: opacity 0.5s ease, visibility 0.5s; }
        #splash-screen.hidden { opacity: 0; visibility: hidden; }
        .splash-container { text-align: center; animation: fadeIn 1s ease-out; }
        .splash-logo { width: 80px; height: 80px; margin-bottom: 20px; border-radius: 12px; }
        .splash-title { font-size: 2.5rem; font-weight: 600; color: var(--text-primary); }
        .splash-subtitle { font-size: 1rem; color: var(--text-secondary); margin-top: 5px; }

        .typing-cursor { display: inline-block; width: 8px; height: 1.2em; background-color: var(--primary-blue); animation: blink 1s step-end infinite; vertical-align: bottom; }
        @keyframes blink { 50% { opacity: 0; } }
        
        @media (max-width: 900px) { .container { flex-direction: column; } .sidebar { flex: 0 0 auto; order: 1; } .main-content { order: 2; } .logo-text { display: none; } }
    </style>
</head>
<body>
    <div id="splash-screen">
        <div class="splash-container">
            <img src="glitch.png" alt="Glitch Logo" class="splash-logo">
            <h1 class="splash-title">Glitch AI</h1>
            <p class="splash-subtitle">Your AI Companion</p>
        </div>
    </div>

    <header>
        <div class="logo">
             <img src="glitch.png" alt="Glitch Logo" class="logo-icon">
             <h1 class="logo-text">Glitch AI</h1>
        </div>
        <div class="header-actions">
            <div class="api-status">
                <div class="status-indicator"></div>
                <span>Connected</span>
            </div>
            <div class="theme-switch-wrapper">
                <label class="theme-switch" for="theme-checkbox">
                    <input type="checkbox" id="theme-checkbox" />
                    <span class="slider round"></span>
                </label>
            </div>
        </div>
    </header>

    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <button class="shine-btn" id="newChatBtn"><i class="fas fa-plus"></i> New Chat</button>
            </div>
            <div>
                <h4 class="sidebar-heading">Models</h4>
                <div class="ai-selector">
                    <div class="ai-option active" data-ai="zhoros"><i class="fas fa-brain"></i> Glitch Zhoros</div>
                    <div class="ai-option" data-ai="plex"><i class="fas fa-bolt"></i> Glitch Plex</div>
                </div>
            </div>
            <div>
                 <h4 class="sidebar-heading">Modes</h4>
                <div class="mode-selector">
                    <button class="mode-btn active" data-mode="chat">Chat</button>
                    <button class="mode-btn" data-mode="code">Code</button>
                    <button class="mode-btn" data-mode="study">Study</button>
                    <button class="mode-btn" data-mode="creative">Creative</button>
                </div>
            </div>
             <h4 class="sidebar-heading">History</h4>
            <div class="chat-history" id="chatHistory"></div>
        </aside>

        <main class="main-content">
            <div class="chat-area" id="chatArea">
                <canvas id="galaxy-canvas"></canvas>
                <div class="chat-header">
                    <h2 id="chatTitle">Chat with Glitch AI</h2>
                </div>
                <div class="messages" id="messages"></div>
                <div class="input-area">
                     <button class="stop-generating-btn" id="stopGeneratingBtn"><i class="fas fa-stop"></i> Stop</button>
                    <div class="input-controls">
                        <button class="input-btn" id="fileInputBtn" title="Attach Files"><i class="fas fa-paperclip"></i></button>
                        <input type="file" id="fileInput" multiple style="display: none;">
                        <textarea class="message-input" id="messageInput" placeholder="Type your message here..." rows="1"></textarea>
                        <button class="send-button" id="sendButton">
                            <span class="send-text"><i class="fas fa-paper-plane"></i></span>
                            <span class="loader"></span>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <footer>
        <p>Glitch AI Assistant</p>
    </footer>

    <audio id="user-typing-sound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_28b18f769b.mp3" preload="auto"></audio>
    <audio id="ai-typing-sound" src="https://cdn.pixabay.com/download/audio/2022/03/07/audio_c358401342.mp3" preload="auto"></audio>
    <audio id="chime-sound" src="https://cdn.pixabay.com/download/audio/2022/03/24/audio_738f192003.mp3" preload="auto"></audio>
    
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
        
        const GEMINI_API_KEY = 'AIzaSyAbcFIlAIYGWWj5lwQYcDjmyL3bCs_X3Qc';

        // ... (rest of the script is largely the same, but with the initGalaxyBackground function restored)

        let currentChatId = null; let chats = {}; let currentMode = 'chat'; let currentAI = 'zhoros'; let isGenerating = false; let abortController = new AbortController(); 
        let lastUserTypingSoundTime = 0; let lastAiTypingSoundTime = 0;
        
        const messageInput = document.getElementById('messageInput'); const sendButton = document.getElementById('sendButton'); const messagesContainer = document.getElementById('messages'); const chatHistory = document.getElementById('chatHistory'); const newChatBtn = document.getElementById('newChatBtn'); const stopGeneratingBtn = document.getElementById('stopGeneratingBtn'); const themeCheckbox = document.getElementById('theme-checkbox');
        
        const sounds = {
            userTyping: document.getElementById('user-typing-sound'),
            aiTyping: document.getElementById('ai-typing-sound'),
            chime: document.getElementById('chime-sound'),
        };
        
        document.addEventListener('DOMContentLoaded', () => {
            const splashScreen = document.getElementById('splash-screen');
            setTimeout(() => { splashScreen.classList.add('hidden'); }, 1500);

            // RESTORED: Initialize the galaxy background
            initGalaxyBackground();

            loadChatsFromStorage(); 
            setupEventListeners();
            
            const savedTheme = localStorage.getItem('glitchTheme');
            const isDarkMode = savedTheme ? savedTheme === 'dark' : true;
            document.body.classList.toggle('light-mode', !isDarkMode);
            themeCheckbox.checked = isDarkMode;

            if (Object.keys(chats).length === 0) { createNewChat(); } 
            else { const latestChatId = Object.keys(chats).sort((a, b) => new Date(chats[b].updatedAt) - new Date(chats[a].updatedAt))[0]; loadChat(latestChatId); }
            loadChatHistory();
        });

        function playSound(soundElement, options = {}) {
            if (soundElement) {
                soundElement.currentTime = 0;
                soundElement.volume = options.volume || 1.0;
                soundElement.play().catch(e => {});
            }
        }

        function setupEventListeners() {
            messageInput.addEventListener('keydown', e => {
                const now = Date.now();
                if (now - lastUserTypingSoundTime > 120) {
                    playSound(sounds.userTyping, { volume: 0.6 });
                    lastUserTypingSoundTime = now;
                }
                if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
            });

            messageInput.addEventListener('input', () => { messageInput.style.height = 'auto'; messageInput.style.height = `${Math.min(messageInput.scrollHeight, 200)}px`; });
            sendButton.addEventListener('click', sendMessage);
            newChatBtn.addEventListener('click', createNewChat);
            stopGeneratingBtn.addEventListener('click', handleStopGeneration);
            
            themeCheckbox.addEventListener('change', () => {
                document.body.classList.toggle('light-mode', !themeCheckbox.checked);
                localStorage.setItem('glitchTheme', themeCheckbox.checked ? 'dark' : 'light');
            });
            
            document.querySelectorAll('.mode-btn').forEach(btn => btn.addEventListener('click', () => {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentMode = btn.dataset.mode;
            }));

            document.querySelectorAll('.ai-option').forEach(opt => opt.addEventListener('click', () => {
                document.querySelectorAll('.ai-option').forEach(o => o.classList.remove('active'));
                opt.classList.add('active');
                currentAI = opt.dataset.ai;
            }));
        }

        // RESTORED: Interactive Galaxy function from the previous version you liked
        function initGalaxyBackground() {
            const chatArea = document.getElementById('chatArea');
            const canvas = document.getElementById('galaxy-canvas');
            if (!canvas || !chatArea) return;
            const scene = new THREE.Scene();
            const parameters = { count: 150000, size: 0.015, radius: 6, branches: 5, spin: 0.8, randomness: 0.4, randomnessPower: 3.5, insideColor: '#5856D6', outsideColor: '#007AFF' };
            let geometry = null, material = null, points = null;
            const generateGalaxy = () => {
                if (points !== null) { geometry.dispose(); material.dispose(); scene.remove(points); }
                geometry = new THREE.BufferGeometry();
                const positions = new Float32Array(parameters.count * 3);
                const colors = new Float32Array(parameters.count * 3);
                const colorInside = new THREE.Color(parameters.insideColor);
                const colorOutside = new THREE.Color(parameters.outsideColor);
                for (let i = 0; i < parameters.count; i++) {
                    const i3 = i * 3;
                    const radius = Math.random() * parameters.radius;
                    const spinAngle = radius * parameters.spin;
                    const branchAngle = (i % parameters.branches) / parameters.branches * Math.PI * 2;
                    const randomX = Math.pow(Math.random(), parameters.randomnessPower) * (Math.random() < 0.5 ? 1 : -1) * parameters.randomness * radius;
                    const randomY = Math.pow(Math.random(), parameters.randomnessPower) * (Math.random() < 0.5 ? 1 : -1) * parameters.randomness * radius;
                    const randomZ = Math.pow(Math.random(), parameters.randomnessPower) * (Math.random() < 0.5 ? 1 : -1) * parameters.randomness * radius;
                    positions[i3] = Math.cos(branchAngle + spinAngle) * radius + randomX;
                    positions[i3 + 1] = randomY;
                    positions[i3 + 2] = Math.sin(branchAngle + spinAngle) * radius + randomZ;
                    const mixedColor = colorInside.clone();
                    mixedColor.lerp(colorOutside, radius / parameters.radius);
                    colors[i3] = mixedColor.r; colors[i3+1] = mixedColor.g; colors[i3+2] = mixedColor.b;
                }
                geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
                geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
                material = new THREE.PointsMaterial({ size: parameters.size, sizeAttenuation: true, depthWrite: false, blending: THREE.AdditiveBlending, vertexColors: true });
                points = new THREE.Points(geometry, material);
                scene.add(points);
            };
            generateGalaxy();
            const sizes = { width: chatArea.clientWidth, height: chatArea.clientHeight };
            const camera = new THREE.PerspectiveCamera(75, sizes.width / sizes.height, 0.1, 100);
            camera.position.z = 3;
            scene.add(camera);
            const renderer = new THREE.WebGLRenderer({ canvas: canvas, alpha: true });
            renderer.setSize(sizes.width, sizes.height);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            const mouse = new THREE.Vector2();
            window.addEventListener('mousemove', (event) => { mouse.x = (event.clientX / window.innerWidth) * 2 - 1; mouse.y = -((event.clientY / window.innerHeight) * 2 - 1); });
            const resizeObserver = new ResizeObserver(entries => {
                for (let entry of entries) {
                    sizes.width = entry.contentRect.width;
                    sizes.height = entry.contentRect.height;
                    camera.aspect = sizes.width / sizes.height;
                    camera.updateProjectionMatrix();
                    renderer.setSize(sizes.width, sizes.height);
                    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                }
            });
            resizeObserver.observe(chatArea);
            const clock = new THREE.Clock();
            const tick = () => {
                const elapsedTime = clock.getElapsedTime();
                if (points) {
                    points.rotation.y = elapsedTime * 0.05;
                    camera.position.x += (mouse.x * 0.5 - camera.position.x) * 0.05;
                    camera.position.y += (mouse.y * 0.5 - camera.position.y) * 0.05;
                    camera.lookAt(scene.position);
                }
                renderer.render(scene, camera);
                window.requestAnimationFrame(tick);
            };
            tick();
        }

        async function sendMessage() {
            const messageText = messageInput.value.trim();
            if (messageText === '' || isGenerating) return;
            isGenerating = true; toggleSendButtonLoading(true); stopGeneratingBtn.style.display = 'flex'; playSound(sounds.chime, { volume: 0.5 });
            const userMessage = { role: 'user', content: messageText };
            chats[currentChatId].messages.push(userMessage);
            displayMessage(userMessage);
            messageInput.value = ''; messageInput.style.height = 'auto';
            const aiMessageId = `ai_${Date.now()}`;
            const aiModelName = currentAI === 'plex' ? 'Glitch Plex' : 'Glitch Zhoros';
            const aiMessagePlaceholder = { role: 'model', senderName: aiModelName, content: '', id: aiMessageId };
            displayMessage(aiMessagePlaceholder);
            const aiMessageElement = document.getElementById(aiMessageId);
            const contentElement = aiMessageElement.querySelector('.message-content');
            contentElement.innerHTML = '<span class="typing-cursor"></span>';
            let accumulatedResponse = "";
            try {
                const model = 'gemini-1.5-pro-latest';
                const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${model}:streamGenerateContent?key=${GEMINI_API_KEY}`;
                const history = chats[currentChatId].messages.slice(0, -1).map(msg => ({ role: msg.role === 'model' ? 'model' : 'user', parts: [{ text: msg.content }] }));
                const contents = [...history, { role: 'user', parts: [{ text: messageText }] }];
                let personaInstruction = "You are Glitch AI, developed by the 'Gaming Odyssey Team'. Your personality is professional, clean, helpful, and concise. Avoid excessive emojis or overly casual language.";
                if (currentMode === 'code') { personaInstruction += " You are now in Code Mode, an expert programmer. Provide complete, well-commented code examples."; }
                const requestBody = { contents, systemInstruction: { parts: [{ text: personaInstruction }] } };
                abortController = new AbortController();
                const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody), signal: abortController.signal });
                if (!response.ok) { throw new Error(`API Error: ${response.status} ${response.statusText}`); }
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const jsonStr = line.substring(6);
                            try {
                                const parsed = JSON.parse(jsonStr);
                                const delta = parsed.candidates[0].content.parts[0].text;
                                if (delta) {
                                    accumulatedResponse += delta;
                                    const now = Date.now();
                                    if (now - lastAiTypingSoundTime > 150) { playSound(sounds.aiTyping, { volume: 0.7 }); lastAiTypingSoundTime = now; }
                                }
                            } catch (e) { /* Ignore parsing errors */ }
                        }
                    }
                    contentElement.innerHTML = marked.parse(accumulatedResponse + '<span class="typing-cursor"></span>');
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            } catch (error) {
                if (error.name !== 'AbortError') { console.error('Error:', error); accumulatedResponse = `Oops! Something went wrong: ${error.message}`; } 
                else { accumulatedResponse += "\n\nGeneration stopped."; }
            } finally {
                contentElement.innerHTML = marked.parse(accumulatedResponse);
                hljs.highlightAll();
                chats[currentChatId].messages.push({ role: 'model', content: accumulatedResponse });
                isGenerating = false; toggleSendButtonLoading(false); stopGeneratingBtn.style.display = 'none';
                saveChatsToStorage(); updateChatHistoryItem(currentChatId);
            }
        }
        
        // --- Other functions (displayMessage, createNewChat, etc.) remain the same ---
        function displayMessage(message) {
            const isUser = message.role === 'user'; const senderClass = isUser ? 'user-message' : 'ai-message'; const messageDiv = document.createElement('div'); messageDiv.className = `message ${senderClass}`; if (message.id) messageDiv.id = message.id; const avatarClass = isUser ? 'user-avatar' : 'ai-avatar'; const avatarIcon = isUser ? 'fa-user' : 'fa-robot'; const avatar = `<div class="avatar ${avatarClass}"><i class="fas ${avatarIcon}"></i></div>`; const senderName = isUser ? 'You' : (message.senderName || 'Glitch AI'); const content = message.content ? marked.parse(message.content) : '';
            messageDiv.innerHTML = `<div class="message-header"> ${avatar} <strong>${senderName}</strong> </div> <div class="message-content">${content}</div>`;
            messagesContainer.appendChild(messageDiv); messagesContainer.scrollTop = messagesContainer.scrollHeight; hljs.highlightAll();
        }
        function handleStopGeneration() { if (isGenerating) { abortController.abort(); } }
        function createNewChat() {
            const chatId = `chat_${Date.now()}`; chats[chatId] = { id: chatId, title: 'New Chat', messages: [{ role: 'model', senderName: 'Glitch AI', content: `Hello! How can I assist you today?` }], createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() };
            currentChatId = chatId; saveChatsToStorage(); loadChat(chatId); loadChatHistory();
        }
        function loadChat(chatId) {
            if (!chats[chatId]) return; currentChatId = chatId; const chat = chats[chatId]; document.getElementById('chatTitle').textContent = chat.title; messagesContainer.innerHTML = ''; chat.messages.forEach(displayMessage);
            document.querySelectorAll('.history-item').forEach(item => item.classList.toggle('active', item.dataset.chatId === chatId));
        }
        function saveChatsToStorage() { sessionStorage.setItem('glitchChats', JSON.stringify(chats)); }
        function loadChatsFromStorage() { chats = JSON.parse(sessionStorage.getItem('glitchChats')) || {}; }
        function loadChatHistory() {
            chatHistory.innerHTML = Object.values(chats).sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt)).map(chat => `<div class="history-item ${chat.id === currentChatId ? 'active' : ''}" data-chat-id="${chat.id}"><div class="history-content" onclick="loadChat('${chat.id}')"><div class="history-title">${chat.title}</div></div><button class="delete-chat-btn" onclick="deleteChat('${chat.id}')" title="Delete Chat"><i class="fas fa-trash"></i></button></div>`).join('');
        }
        function deleteChat(chatId) {
            if (Object.keys(chats).length <= 1) { alert("You can't delete your only chat!"); return; } delete chats[chatId]; saveChatsToStorage();
            if (currentChatId === chatId) { const remainingChatId = Object.keys(chats).sort((a, b) => new Date(chats[b].updatedAt) - new Date(chats[a].updatedAt))[0]; loadChat(remainingChatId); }
            loadChatHistory();
        }
        function updateChatHistoryItem(chatId) {
            const chat = chats[chatId]; const userMessages = chat.messages.filter(m => m.role === 'user');
            if (userMessages.length > 0 && chat.title === 'New Chat') { const newTitle = userMessages[0].content.substring(0, 30) + '...'; chat.title = newTitle; document.getElementById('chatTitle').textContent = newTitle; }
            chat.updatedAt = new Date().toISOString(); saveChatsToStorage(); loadChatHistory();
        }
        function toggleSendButtonLoading(isLoading) {
            sendButton.querySelector('.send-text').style.display = isLoading ? 'none' : 'flex';
            sendButton.querySelector('.loader').style.display = isLoading ? 'block' : 'none';
            sendButton.disabled = isLoading;
        }

    </script>
</body>
</html>
