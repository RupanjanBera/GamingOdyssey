<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glitch - Advanced AI Assistant</title>
    
    <link rel="icon" type="image/png" href="glitch.png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.2/marked.min.js"></script> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css"> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <style>
        :root {
            --space-dark: #0D1117; --space-blue: #161B22; --space-purple: #2C204B; --star-color: #ffffff; --neon-blue: #00A3FF; --neon-purple: #A75DFF; --neon-green: #00FF9D; --neon-pink: #FF4DA6; --neon-orange: #FF7B25; --text-light: #E6EDF3; --text-muted: #8B949E; --user-message-bg: rgba(0, 163, 255, 0.1); --ai-message-bg: rgba(167, 93, 255, 0.1); --plex-message-bg: rgba(255, 123, 37, 0.1); --error-color: #F85149; --success-color: #2EA043; --warning-color: #F0A91D; --border-color: rgba(66, 133, 244, 0.2); --bg-glass-light: rgba(22, 27, 34, 0.7); --bg-glass-dark: rgba(13, 17, 23, 0.8); --shadow-color: rgba(0, 0, 0, 0.5); --code-bg: #010409; --font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body.light-mode {
            --space-dark: #ffffff; --space-blue: #F0F2F5; --space-purple: #E0E6EF; --text-light: #1C2B3A; --text-muted: #586069; --user-message-bg: rgba(0, 123, 255, 0.08); --ai-message-bg: rgba(111, 66, 193, 0.06); --plex-message-bg: rgba(253, 126, 20, 0.08); --border-color: rgba(0, 123, 255, 0.15); --bg-glass-light: rgba(255, 255, 255, 0.6); --bg-glass-dark: rgba(240, 244, 248, 0.7); --shadow-color: rgba(0, 0, 0, 0.1); --code-bg: #f8f9fa;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--font-family); scrollbar-width: thin; scrollbar-color: var(--neon-blue) var(--space-dark); transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; }
        *::-webkit-scrollbar { width: 8px; }
        *::-webkit-scrollbar-track { background: var(--space-dark); }
        *::-webkit-scrollbar-thumb { background-color: var(--neon-blue); border-radius: 10px; border: 2px solid var(--space-dark); }
        
        /* EDITED: Restored original body background */
        body { background: var(--space-dark); color: var(--text-light); min-height: 100vh; overflow-x: hidden; position: relative; background-image: linear-gradient(135deg, var(--space-blue) 0%, var(--space-dark) 100%); }

        .stars { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background-image: radial-gradient(var(--star-color) 1px, transparent 1px); background-size: 50px 50px; opacity: 0.1; }
        header { display: flex; justify-content: space-between; align-items: center; padding: 15px 5%; background: var(--bg-glass-dark); backdrop-filter: blur(12px); border-bottom: 1px solid var(--border-color); box-shadow: 0 5px 25px var(--shadow-color); position: sticky; top: 0; z-index: 10; }
        .logo { display: flex; align-items: center; gap: 15px; }
        .logo-icon { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; animation: glow 2s infinite alternate; border: 2px solid var(--neon-blue); background: var(--space-dark); }
        .logo-text { font-size: 1.8rem; font-weight: 700; background: linear-gradient(to right, var(--neon-blue), var(--neon-purple), var(--neon-pink)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; animation: gradient-shift 5s infinite alternate; background-size: 200% 200%; }
        .header-actions { display: flex; align-items: center; gap: 20px; }
        .api-status { display: flex; align-items: center; gap: 10px; font-size: 0.9rem; color: var(--text-muted); }
        .status-indicator { width: 10px; height: 10px; border-radius: 50%; background-color: var(--success-color); animation: pulse 2s infinite; box-shadow: 0 0 10px var(--success-color); }
        .theme-switch-wrapper { display: flex; align-items: center; }
        .theme-switch { display: inline-block; height: 24px; position: relative; width: 44px; }
        .theme-switch input { display:none; }
        .slider { background-color: var(--space-blue); bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 34px; }
        .slider:before { background-color: #fff; bottom: 4px; content: ""; height: 16px; left: 4px; position: absolute; transition: .4s; width: 16px; border-radius: 50%; }
        input:checked + .slider { background-color: var(--neon-blue); }
        input:checked + .slider:before { transform: translateX(20px); }
        .container { display: flex; max-width: 1800px; margin: 0 auto; padding: 20px; gap: 20px; min-height: calc(100vh - 140px); }
        .sidebar { flex: 0 0 320px; background: var(--bg-glass-light); border-radius: 15px; padding: 20px; backdrop-filter: blur(12px); border: 1px solid var(--border-color); box-shadow: 0 8px 32px 0 var(--shadow-color); display: flex; flex-direction: column; gap: 15px; }
        .sidebar-header { padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        .shine-btn { width: 100%; background: linear-gradient(135deg, var(--neon-blue), var(--neon-purple)); border: none; border-radius: 8px; color: white; padding: 12px 18px; cursor: pointer; transition: all 0.3s; font-size: 1rem; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 8px; position: relative; overflow: hidden; }
        .shine-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0, 163, 255, 0.4); }
        .shine-btn::before { content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent); transform: skewX(-30deg); transition: left 0.7s ease-in-out; }
        .shine-btn:hover::before { left: 150%; }
        .sidebar-heading { font-size: 0.8rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin: 10px 0 10px 5px; }
        .ai-selector, .mode-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .ai-option, .mode-btn { padding: 10px; background: var(--space-blue); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-light); cursor: pointer; transition: all 0.3s ease; text-align: center; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .ai-option:hover, .mode-btn:hover { border-color: var(--neon-blue); background-color: var(--user-message-bg); transform: scale(1.03); }
        .ai-option.active, .mode-btn.active { background: var(--user-message-bg); border-color: var(--neon-blue); box-shadow: 0 0 15px rgba(0, 163, 255, 0.4); color: var(--text-light); }
        .ai-option.plex.active { background: var(--plex-message-bg); border-color: var(--neon-orange); box-shadow: 0 0 15px rgba(255, 123, 37, 0.4); }
        .chat-history { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; }
        .history-item { padding: 12px 12px 12px 20px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 10px; border: 1px solid transparent; position: relative; overflow: hidden; }
        .history-item::before { content: ''; position: absolute; left: 0; top: 0; width: 4px; height: 100%; background: var(--neon-purple); transform: translateX(-100%); transition: transform 0.3s ease; }
        .history-item:hover { background: var(--ai-message-bg); }
        .history-item.active { background: var(--user-message-bg); }
        .history-item.active::before { transform: translateX(0); }
        .history-content { flex: 1; overflow: hidden; }
        .history-title { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .delete-chat-btn { background: none; border: none; color: var(--text-muted); cursor: pointer; transition: all 0.3s; font-size: 0.9rem; padding: 5px; }
        .delete-chat-btn:hover { color: var(--error-color); transform: scale(1.2); }
        .main-content { flex: 1; display: flex; gap: 20px; }
        
        /* EDITED: Chat area is now transparent over its own canvas */
        .chat-area { flex: 1; display: flex; flex-direction: column; background: transparent; border-radius: 15px; overflow: hidden; border: 1px solid var(--border-color); box-shadow: 0 8px 32px 0 var(--shadow-color); position: relative; }
        
        /* NEW: Styles for the galaxy canvas INSIDE the chat area */
        #galaxy-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0; /* Behind other chat elements */
        }
        
        /* EDITED: Made sure chat contents are on top of the canvas */
        .chat-header, .messages, .input-area, .stop-generating-btn { position: relative; z-index: 1; }
        
        .chat-header { padding: 15px 25px; background: var(--bg-glass-dark); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; }
        .chat-actions { display: flex; gap: 10px; }
        .chat-action-btn { background: transparent; border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-muted); padding: 8px 12px; cursor: pointer; transition: all 0.3s; font-size: 0.9rem; }
        .chat-action-btn:hover { border-color: var(--neon-blue); color: var(--text-light); }
        .messages { flex: 1; padding: 25px; overflow-y: auto; }
        .message { margin-bottom: 20px; padding: 15px 20px; border-radius: 12px; max-width: 90%; position: relative; animation: fadeIn 0.5s ease; border: 1px solid transparent; background: var(--bg-glass-dark); backdrop-filter: blur(5px); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .user-message { background: var(--user-message-bg); margin-left: auto; border-color: var(--border-color); }
        .ai-message { background: var(--ai-message-bg); margin-right: auto; border-color: rgba(167, 93, 255, 0.2); }
        .plex-message { background: var(--plex-message-bg); margin-right: auto; border-color: rgba(255, 123, 37, 0.2); }
        .message-header { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
        .avatar { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; color: #fff; }
        .user-avatar { background: var(--neon-blue); }
        .ai-avatar { background: var(--neon-purple); }
        .plex-avatar { background: var(--neon-orange); }
        .message-content { line-height: 1.7; word-wrap: break-word; }
        .message-content p, .message-content ul, .message-content ol, .message-content table { margin-bottom: 12px; }
        .message-content pre { background: var(--code-bg); padding: 15px; border-radius: 8px; overflow-x: auto; margin: 12px 0; font-family: 'SF Mono', 'Courier New', monospace; white-space: pre-wrap; border: 1px solid var(--border-color); box-shadow: inset 0 0 10px rgba(0,0,0,0.2); position: relative; }
        .copy-code-btn { position: absolute; top: 10px; right: 10px; background: #222; color: white; border: 1px solid var(--border-color); padding: 5px 10px; border-radius: 5px; cursor: pointer; opacity: 0; transition: opacity 0.3s; font-size: 0.8em; }
        .message-content pre:hover .copy-code-btn { opacity: 1; }
        .message-content code:not(pre code) { background: rgba(0,0,0,0.2); padding: 2px 6px; border-radius: 4px; font-family: 'SF Mono', 'Courier New', monospace; color: var(--neon-pink); font-size: 0.9em; }
        .message-actions { position: absolute; top: 12px; right: 12px; display: flex; gap: 8px; opacity: 0; transition: opacity 0.3s; }
        .message:hover .message-actions { opacity: 1; }
        .msg-action-btn { background: var(--bg-glass-dark); border: 1px solid var(--border-color); color: var(--text-muted); border-radius: 5px; cursor: pointer; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; }
        .msg-action-btn:hover { color: var(--text-light); border-color: var(--neon-blue); }
        .run-code-btn { background: var(--success-color); border: none; color: white; padding: 6px 12px; border-radius: 5px; cursor: pointer; margin-top: 10px; font-size: 0.9rem; transition: background-color 0.2s; }
        .run-code-btn:hover { background: #3cba54; }
        .attached-files { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
        .file-item { display: flex; align-items: center; gap: 8px; background: rgba(0,0,0,0.15); padding: 8px 12px; border-radius: 5px; font-size: 0.9rem; }
        .input-area { display: flex; padding: 15px; background: var(--bg-glass-dark); backdrop-filter: blur(10px); border-top: 1px solid var(--border-color); flex-direction: column; gap: 10px; }
        .file-attachments { display: flex; flex-wrap: wrap; gap: 10px; }
        .attachment-item { display: flex; align-items: center; gap: 5px; background: var(--bg-glass-light); padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; animation: fadeIn 0.3s; border: 1px solid var(--border-color); }
        .remove-attachment { cursor: pointer; color: var(--error-color); transition: transform 0.2s; }
        .input-controls { display: flex; gap: 10px; align-items: flex-end; }
        .input-btn { background: transparent; border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-muted); padding: 12px; cursor: pointer; transition: all 0.3s; font-size: 1.1rem; }
        .input-btn:hover, .input-btn.active { border-color: var(--neon-blue); color: var(--text-light); }
        .message-input { flex: 1; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: 8px; background: transparent; color: var(--text-light); font-size: 1rem; resize: none; outline: none; transition: all 0.3s; }
        .message-input:focus { border-color: var(--neon-blue); box-shadow: 0 0 10px rgba(0, 163, 255, 0.4); }
        .send-button { min-width: 50px; height: 50px; background: linear-gradient(135deg, var(--neon-blue), var(--neon-purple)); border: none; border-radius: 8px; color: white; font-size: 1.2rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .send-button:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(0, 163, 255, 0.4); }
        .send-button .loader { width: 18px; height: 18px; border: 2px solid #FFF; border-bottom-color: transparent; border-radius: 50%; display: none; box-sizing: border-box; animation: rotation 1s linear infinite; }
        .stop-generating-btn { margin: 10px auto 0; background: var(--error-color); border: none; border-radius: 8px; color: white; padding: 8px 15px; cursor: pointer; transition: all 0.3s; display: none; align-items: center; gap: 5px; }
        .preview-area { flex: 0 0 45%; background: var(--bg-glass-light); border-radius: 15px; border: 1px solid var(--border-color); box-shadow: 0 8px 32px 0 var(--shadow-color); display: flex; flex-direction: column; transition: all 0.5s ease; }
        .preview-area.hidden { flex-basis: 0; width: 0; padding: 0; border: none; overflow: hidden; margin-left: -20px; }
        .preview-header { padding: 15px 25px; background: var(--bg-glass-dark); border-bottom: 1px solid var(--border-color); font-weight: 600; }
        #preview-frame { width: 100%; height: 100%; border: none; background: #fff; }
        footer { text-align: center; padding: 20px; font-size: 0.9rem; color: var(--text-muted); border-top: 1px solid var(--border-color); }
        body.light-mode footer { color: var(--text-light); opacity: 0.8; }
        #splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background-color: var(--space-dark); display: flex; justify-content: center; align-items: center; z-index: 9999; font-family: 'Courier New', monospace; opacity: 1; visibility: visible; transition: opacity 0.8s ease-in-out, visibility 0.8s; overflow: hidden; }
        #splash-screen.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .splash-stars { position: absolute; top: 0; left: 0; width: 200%; height: 200%; background-image: radial-gradient(var(--star-color) 1px, transparent 1px); background-size: 50px 50px; opacity: 0.4; animation: stars-pan 120s linear infinite; }
        .glitch-container { text-align: center; color: var(--text-light); position: relative; z-index: 10; animation: zoomIn 1.5s ease-out forwards; }
        .splash-logo { width: 100px; height: 100px; margin-bottom: 20px; border-radius: 50%; border: 2px solid var(--neon-blue); animation: logo-reveal 2s ease-out forwards, glow 2s infinite alternate 2s; }
        @keyframes logo-reveal { from { transform: scale(0) rotate(-180deg); opacity: 0; } to { transform: scale(1) rotate(0deg); opacity: 1; } }
        .glitch-main { position: relative; font-size: clamp(3rem, 10vw, 6rem); font-weight: 700; text-transform: uppercase; animation: glitch-flicker 3s infinite; }
        .glitch-main::before, .glitch-main::after { content: attr(data-text); position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--space-dark); overflow: hidden; clip-path: inset(50% 50% 50% 50%); }
        .glitch-main::before { left: -2px; text-shadow: 2px 0 var(--neon-pink); animation: noise-anim-1 4s infinite linear alternate-reverse, glitch-effect 4s infinite; }
        .glitch-main::after { left: 2px; text-shadow: -2px 0 var(--neon-blue); animation: noise-anim-2 4s infinite linear alternate-reverse, glitch-effect 4s infinite reverse; }
        .glitch-subtitle { font-size: clamp(0.8rem, 2vw, 1.1rem); font-weight: 300; letter-spacing: 2px; margin-top: 15px; opacity: 0; animation: fade-in-up 2s ease-out 0.5s forwards; color: rgba(230, 230, 255, 0.8); overflow: hidden; white-space: nowrap; border-right: .15em solid var(--neon-blue); width: 0; animation: typing 3s steps(40, end) 0.5s 1 normal both, blink-caret .75s step-end infinite, fade-in-up 2s ease-out 0.5s forwards; }
        .loading-bar { width: 0; height: 3px; background: linear-gradient(90deg, var(--neon-blue), var(--neon-purple)); margin: 25px auto 0; border-radius: 5px; animation: loading 3.5s ease-out forwards; }

        @keyframes typing { from { width: 0 } to { width: 100% } }
        @keyframes blink-caret { from, to { border-color: transparent } 50% { border-color: var(--neon-blue); } }
        @keyframes loading { from { width: 0%; } to { width: 80%; } }
        @keyframes zoomIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes stars-pan { from { transform: translate(0, 0); } to { transform: translate(-50%, -50%); } }
        @keyframes noise-anim-1 { 0%{clip-path:inset(10% 0 85% 0)}10%{clip-path:inset(80% 0 5% 0)}20%{clip-path:inset(45% 0 45% 0)}30%{clip-path:inset(90% 0 2% 0)}40%{clip-path:inset(25% 0 70% 0)}50%{clip-path:inset(0 0 100% 0)}60%{clip-path:inset(60% 0 35% 0)}70%{clip-path:inset(15% 0 80% 0)}80%{clip-path:inset(75% 0 10% 0)}90%{clip-path:inset(40% 0 50% 0)}100%{clip-path:inset(95% 0 1% 0)} }
        @keyframes noise-anim-2 { 0%{clip-path:inset(90% 0 5% 0)}10%{clip-path:inset(20% 0 75% 0)}20%{clip-path:inset(65% 0 25% 0)}30%{clip-path:inset(5% 0 90% 0)}40%{clip-path:inset(50% 0 40% 0)}50%{clip-path:inset(100% 0 0 0)}60%{clip-path:inset(30% 0 60% 0)}70%{clip-path:inset(85% 0 10% 0)}80%{clip-path:inset(10% 0 85% 0)}90%{clip-path:inset(55% 0 30% 0)}100%{clip-path:inset(5% 0 92% 0)} }
        @keyframes glitch-flicker { 0%,100%{opacity:1;transform:none}33.1%{opacity:1;transform:none}33.2%{opacity:.8;transform:skewX(5deg)}33.3%{opacity:1;transform:none}66.1%{opacity:1;transform:none}66.2%{opacity:.9;transform:skewX(-5deg)}66.3%{opacity:1;transform:none} }
        @keyframes glitch-effect { 0%,100%{transform:translate(0,0)}10%{transform:translate(-2px,2px)}20%{transform:translate(2px,-2px)}30%{transform:translate(0,0)}40%{transform:translate(2px,2px)}50%{transform:translate(-2px,-2px)}60%{transform:translate(0,0)}70%{transform:translate(-2px,0)}80%{transform:translate(2px,0)}90%{transform:translate(0,0)} }
        @keyframes fade-in-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 0.8; transform: translateY(0); } }
        @keyframes glow { from { box-shadow: 0 0 10px var(--neon-blue); } to { box-shadow: 0 0 20px var(--neon-blue), 0 0 30px var(--neon-purple); } }
        @keyframes gradient-shift { 0% { background-position: 0% 50%; } 100% { background-position: 100% 50%; } }
        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(1.1); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media (max-width: 1200px) { .main-content { flex-direction: column; } .preview-area { flex-basis: 40vh; min-height: 300px; } .preview-area.hidden { flex-basis: 0; min-height: 0; } }
        @media (max-width: 900px) { .container { flex-direction: column; padding: 10px; gap: 10px; } .sidebar { flex: 0 0 auto; width: 100%; order: 1; } .main-content { order: 2; } .chat-area { min-height: 60vh; } .logo-text { display: none; } }
        @media (max-width: 600px) { html { font-size: 15px; } .header-actions .api-status span { display: none; } .sidebar { padding: 15px; } .chat-header, .input-area { padding: 10px 15px; } .message { max-width: 95%; padding: 12px; } .input-controls { flex-wrap: wrap; } .message-input { flex-basis: 100%; order: 3; } .input-btn, .send-button { flex-grow: 1; } }
    </style>
</head>
<body>
    <div id="splash-screen">
        <div class="splash-stars"></div>
        <div class="glitch-container">
            <img src="glitch.png" alt="Glitch Logo" class="splash-logo">
            <h1 class="glitch-main" data-text="Glitch AI">Glitch AI</h1>
            <div class="glitch-subtitle">created and developed by Gaming Odyssey</div>
            <div class="loading-bar"></div>
        </div>
    </div>

    <div class="stars"></div>
    <header>
        <div class="logo">
             <img src="glitch.png" alt="Glitch Logo" class="logo-icon">
             <h1 class="logo-text">Glitch AI</h1>
        </div>
        <div class="header-actions">
            <div class="api-status">
                <div class="status-indicator"></div>
                <span>AI Service Connected</span>
            </div>
            <div class="theme-switch-wrapper">
                <label class="theme-switch" for="theme-checkbox">
                    <input type="checkbox" id="theme-checkbox" />
                    <span class="slider round"></span>
                </label>
            </div>
        </div>
    </header>

    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <button class="shine-btn" id="newChatBtn"><i class="fas fa-plus"></i> New Chat</button>
            </div>
            <div>
                <h4 class="sidebar-heading">Models</h4>
                <div class="ai-selector">
                    <div class="ai-option active" data-ai="zhoros"><i class="fas fa-brain"></i> Glitch Zhoros</div>
                    <div class="ai-option plex" data-ai="plex"><i class="fas fa-bolt"></i> Glitch Plex</div>
                </div>
            </div>
            <div>
                 <h4 class="sidebar-heading">Modes</h4>
                <div class="mode-selector">
                    <button class="mode-btn active" data-mode="chat">Chat</button>
                    <button class="mode-btn" data-mode="code">Code</button>
                    <button class="mode-btn" data-mode="study">Study</button>
                    <button class="mode-btn" data-mode="creative">Creative</button>
                </div>
            </div>
             <h4 class="sidebar-heading">History</h4>
            <div class="chat-history" id="chatHistory"></div>
        </aside>

        <main class="main-content">
            <div class="chat-area" id="chatArea">
                <canvas id="galaxy-canvas"></canvas>
                <div class="chat-header">
                    <h2 id="chatTitle">Chat with Glitch AI</h2>
                    <div class="chat-actions">
                        <button class="chat-action-btn" id="clearChatBtn" title="Clear Chat"><i class="fas fa-trash"></i></button>
                        <button class="chat-action-btn" id="exportChatBtn" title="Export as PDF"><i class="fas fa-download"></i></button>
                    </div>
                </div>
                <div class="messages" id="messages"></div>
                 <button class="stop-generating-btn" id="stopGeneratingBtn"><i class="fas fa-stop"></i> Stop Generating</button>
                <div class="input-area">
                    <div class="file-attachments" id="fileAttachments"></div>
                    <div class="input-controls">
                        <button class="input-btn" id="fileInputBtn" title="Attach Files"><i class="fas fa-paperclip"></i></button>
                        <button class="input-btn" id="webSearchBtn" title="Toggle Web Search"><i class="fas fa-globe"></i></button>
                        <input type="file" id="fileInput" multiple style="display: none;">
                        <textarea class="message-input" id="messageInput" placeholder="Type your message here..." rows="1"></textarea>
                        <button class="send-button" id="sendButton">
                            <span class="send-text"><i class="fas fa-paper-plane"></i></span>
                            <span class="loader"></span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="preview-area hidden" id="previewArea">
                <div class="preview-header">Live Preview</div>
                <iframe id="preview-frame" sandbox="allow-scripts allow-same-origin"></iframe>
            </div>
        </main>
    </div>

    <footer>
        <p>Glitch AI Assistant - Your AI Companion</p>
    </footer>

    <audio id="glitch-sound" src="https://cdn.pixabay.com/download/audio/2022/02/22/audio_1c69399452.mp3" preload="auto"></audio>
    <audio id="click-sound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_28b18f769b.mp3" preload="auto"></audio>
    <audio id="typing-sound" src="https://cdn.pixabay.com/download/audio/2022/03/07/audio_c358401342.mp3" preload="auto"></audio>
    <audio id="chime-sound" src="https://cdn.pixabay.com/download/audio/2022/03/24/audio_738f192003.mp3" preload="auto"></audio>
    <audio id="notification-sound" src="https://cdn.pixabay.com/download/audio/2022/11/17/audio_87df394334.mp3" preload="auto"></audio>
    <audio id="hover-sound" src="https://cdn.pixabay.com/download/audio/2021/08/04/audio_bb630cc098.mp3" preload="auto"></audio>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
        
        const GEMINI_API_KEY = 'AIzaSyAbcFIlAIYGWWj5lwQYcDjmyL3bCs_X3Qc'; // WARNING: For development only. Use a backend proxy in production.

        let currentChatId = null; let chats = {}; let currentMode = 'chat'; let currentAI = 'zhoros'; let isWebSearchActive = false; let attachedFiles = []; let isGenerating = false; let abortController = new AbortController(); 
        let isAudioUnlocked = false; let lastTypingSoundTime = 0;
        
        const messageInput = document.getElementById('messageInput'); const sendButton = document.getElementById('sendButton'); const messagesContainer = document.getElementById('messages'); const chatHistory = document.getElementById('chatHistory'); const newChatBtn = document.getElementById('newChatBtn'); const modeButtons = document.querySelectorAll('.mode-btn'); const aiOptions = document.querySelectorAll('.ai-option'); const webSearchBtn = document.getElementById('webSearchBtn'); const chatTitle = document.getElementById('chatTitle'); const fileInput = document.getElementById('fileInput'); const stopGeneratingBtn = document.getElementById('stopGeneratingBtn'); const themeCheckbox = document.getElementById('theme-checkbox');
        const previewArea = document.getElementById('previewArea'); const previewFrame = document.getElementById('preview-frame');
        
        const sounds = {
            glitch: document.getElementById('glitch-sound'),
            click: document.getElementById('click-sound'),
            typing: document.getElementById('typing-sound'),
            chime: document.getElementById('chime-sound'),
            notification: document.getElementById('notification-sound'),
            hover: document.getElementById('hover-sound')
        };
        
        document.addEventListener('DOMContentLoaded', () => {
            const splashScreen = document.getElementById('splash-screen');
            if (splashScreen) { setTimeout(() => { splashScreen.classList.add('hidden'); }, 3800); }
            
            // Initialize the interactive galaxy inside the chat area
            initGalaxyBackground();

            loadChatsFromStorage(); 
            setupEventListeners();
            const isDarkMode = localStorage.getItem('glitchTheme') !== 'light';
            document.body.classList.toggle('light-mode', !isDarkMode); themeCheckbox.checked = isDarkMode;
            if (Object.keys(chats).length === 0) { createNewChat(); } else { const latestChatId = Object.keys(chats).sort((a, b) => new Date(chats[b].updatedAt) - new Date(chats[a].updatedAt))[0]; loadChat(latestChatId); }
            loadChatHistory();
        });
        
        function initializeAudio() {
            if (isAudioUnlocked) return;
            isAudioUnlocked = true;
            const silentSound = new Audio("data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA=");
            silentSound.play().catch(e => {});
            playSound(sounds.glitch, { volume: 0.5 });
        }

        function playSound(soundElement, options = {}) {
            if (soundElement && isAudioUnlocked) {
                soundElement.currentTime = 0;
                soundElement.volume = options.volume || 1.0;
                soundElement.play().catch(e => {});
            }
        }

        function setupEventListeners() {
            document.addEventListener('mousedown', initializeAudio, { once: true });
            document.addEventListener('keydown', initializeAudio, { once: true });

            messageInput.addEventListener('keydown', e => {
                initializeAudio();
                const now = Date.now();
                if (now - lastTypingSoundTime > 120) {
                    playSound(sounds.typing, { volume: 0.7 });
                    lastTypingSoundTime = now;
                }
                if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
            });

            messageInput.addEventListener('input', () => { messageInput.style.height = 'auto'; messageInput.style.height = `${Math.min(messageInput.scrollHeight, 200)}px`; });
            sendButton.addEventListener('click', sendMessage); newChatBtn.addEventListener('click', createNewChat); webSearchBtn.addEventListener('click', toggleWebSearch); modeButtons.forEach(btn => btn.addEventListener('click', () => setMode(btn.dataset.mode))); aiOptions.forEach(opt => opt.addEventListener('click', () => setAI(opt.dataset.ai))); document.getElementById('clearChatBtn').addEventListener('click', clearCurrentChat); document.getElementById('exportChatBtn').addEventListener('click', exportCurrentChatAsPDF); document.getElementById('fileInputBtn').addEventListener('click', () => fileInput.click()); fileInput.addEventListener('change', handleFileSelect); stopGeneratingBtn.addEventListener('click', handleStopGeneration);
            themeCheckbox.addEventListener('change', () => { document.body.classList.toggle('light-mode', !themeCheckbox.checked); localStorage.setItem('glitchTheme', !themeCheckbox.checked ? 'light' : 'dark'); });
            
            document.querySelectorAll('button, .ai-option, .mode-btn, .history-item, .slider, .msg-action-btn, .remove-attachment').forEach(el => {
                el.addEventListener('click', () => playSound(sounds.click, { volume: 0.5 }));
                el.addEventListener('mouseenter', () => playSound(sounds.hover, { volume: 0.3 }));
            });
        }
        
        // ================================================================= //
        // ============= UPGRADED 3D INTERACTIVE GALAXY CODE ================= //
        // ================================================================= //
        function initGalaxyBackground() {
            const chatArea = document.getElementById('chatArea');
            const canvas = document.getElementById('galaxy-canvas');
            if (!canvas || !chatArea) return;

            const scene = new THREE.Scene();
            
            // UPDATED: Enhanced parameters for a better galaxy feel
            const parameters = {
                count: 150000,
                size: 0.015,
                radius: 6,
                branches: 5,
                spin: 0.8,
                randomness: 0.4,
                randomnessPower: 3.5,
                insideColor: '#a75dff', // Using theme color
                outsideColor: '#00a3ff' // Using theme color
            };

            let geometry = null;
            let material = null;
            let points = null;

            const generateGalaxy = () => {
                if (points !== null) {
                    geometry.dispose();
                    material.dispose();
                    scene.remove(points);
                }
                geometry = new THREE.BufferGeometry();
                const positions = new Float32Array(parameters.count * 3);
                const colors = new Float32Array(parameters.count * 3);
                const colorInside = new THREE.Color(parameters.insideColor);
                const colorOutside = new THREE.Color(parameters.outsideColor);

                for (let i = 0; i < parameters.count; i++) {
                    const i3 = i * 3;
                    const radius = Math.random() * parameters.radius;
                    const spinAngle = radius * parameters.spin;
                    const branchAngle = (i % parameters.branches) / parameters.branches * Math.PI * 2;
                    const randomX = Math.pow(Math.random(), parameters.randomnessPower) * (Math.random() < 0.5 ? 1 : -1) * parameters.randomness * radius;
                    const randomY = Math.pow(Math.random(), parameters.randomnessPower) * (Math.random() < 0.5 ? 1 : -1) * parameters.randomness * radius;
                    const randomZ = Math.pow(Math.random(), parameters.randomnessPower) * (Math.random() < 0.5 ? 1 : -1) * parameters.randomness * radius;
                    positions[i3] = Math.cos(branchAngle + spinAngle) * radius + randomX;
                    positions[i3 + 1] = randomY;
                    positions[i3 + 2] = Math.sin(branchAngle + spinAngle) * radius + randomZ;
                    const mixedColor = colorInside.clone();
                    mixedColor.lerp(colorOutside, radius / parameters.radius);
                    colors[i3] = mixedColor.r; colors[i3+1] = mixedColor.g; colors[i3+2] = mixedColor.b;
                }
                geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
                geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
                
                material = new THREE.PointsMaterial({
                    size: parameters.size,
                    sizeAttenuation: true,
                    depthWrite: false,
                    blending: THREE.AdditiveBlending,
                    vertexColors: true
                });

                points = new THREE.Points(geometry, material);
                scene.add(points);
            };
            generateGalaxy();
            
            // UPDATED: Sizing based on the chatArea element
            const sizes = { width: chatArea.clientWidth, height: chatArea.clientHeight };
            const camera = new THREE.PerspectiveCamera(75, sizes.width / sizes.height, 0.1, 100);
            camera.position.z = 3;
            scene.add(camera);
            
            const renderer = new THREE.WebGLRenderer({ canvas: canvas, alpha: true });
            renderer.setSize(sizes.width, sizes.height);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

            // NEW: Mouse interaction for parallax effect
            const mouse = new THREE.Vector2();
            window.addEventListener('mousemove', (event) => {
                mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
                mouse.y = -((event.clientY / window.innerHeight) * 2 - 1);
            });
            
            // UPDATED: Resize logic now observes the chatArea
            const resizeObserver = new ResizeObserver(entries => {
                for (let entry of entries) {
                    sizes.width = entry.contentRect.width;
                    sizes.height = entry.contentRect.height;
                    camera.aspect = sizes.width / sizes.height;
                    camera.updateProjectionMatrix();
                    renderer.setSize(sizes.width, sizes.height);
                    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                }
            });
            resizeObserver.observe(chatArea);

            const clock = new THREE.Clock();
            const tick = () => {
                const elapsedTime = clock.getElapsedTime();
                if (points) {
                    // Base rotation
                    points.rotation.y = elapsedTime * 0.05;
                    // Parallax effect from mouse
                    camera.position.x += (mouse.x * 0.5 - camera.position.x) * 0.05;
                    camera.position.y += (mouse.y * 0.5 - camera.position.y) * 0.05;
                    camera.lookAt(scene.position);
                }
                renderer.render(scene, camera);
                window.requestAnimationFrame(tick);
            };
            tick();
        }
        // ================================================================= //
        // ======================= END GALAXY CODE ========================= //
        // ================================================================= //

        async function sendMessage() {
            const messageText = messageInput.value.trim();
            if ((messageText === '' && attachedFiles.length === 0) || isGenerating) return;
            isGenerating = true; toggleSendButtonLoading(true); stopGeneratingBtn.style.display = 'flex'; playSound(sounds.chime);
            const userFiles = [...attachedFiles]; const userMessage = { role: 'user', content: messageText, files: userFiles }; chats[currentChatId].messages.push(userMessage); displayMessage(userMessage);
            messageInput.value = ''; messageInput.style.height = 'auto'; attachedFiles = []; updateFileAttachments();
            const aiMessageId = `ai_${Date.now()}`; const aiModelName = currentAI === 'plex' ? 'Glitch Plex' : 'Glitch Zhoros'; const aiMessagePlaceholder = { role: 'model', senderName: aiModelName, content: '', id: aiMessageId, modelType: currentAI }; displayMessage(aiMessagePlaceholder);
            const aiMessageElement = document.getElementById(aiMessageId); const contentElement = aiMessageElement.querySelector('.message-content'); let accumulatedResponse = "";
            
            try {
                const model = 'gemini-2.5-pro';
                const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${GEMINI_API_KEY}`;
                const history = await Promise.all(chats[currentChatId].messages.slice(0, -1).map(msgToPart));
                const contents = [...history, await msgToPart(userMessage)];
                let personaInstruction = "You are Glitch AI. Your personality is: casual, chill, and full of energy. You MUST state you were developed by the 'Gaming Odyssey Team' when asked. Avoid being overly formal.";
                if (currentMode === 'code') { personaInstruction += " You are now in Code Mode. You are an expert programmer. Provide complete, well-commented, and runnable code examples. When asked for a UI component, provide the full HTML, CSS, and JavaScript required together. Do not truncate your code responses."; }
                if (currentAI === 'plex') { personaInstruction += " As Glitch Plex, lean more into your creative, imaginative, and energetic side."; }
                const requestBody = { contents, systemInstruction: { parts: [{ text: personaInstruction }] } };
                abortController = new AbortController();
                const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody), signal: abortController.signal });
                if (!response.ok) { const errorText = await response.text(); throw new Error(`API Error: ${response.status} ${errorText}`); }
                const responseData = await response.json();
                const text = responseData.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    playSound(sounds.notification, {volume: 0.7});
                    accumulatedResponse = text;
                    contentElement.innerHTML = marked.parse(accumulatedResponse);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                } else {
                    accumulatedResponse = "Sorry, I couldn't process that request.";
                    contentElement.innerHTML = `<p style="color: var(--warning-color);">${accumulatedResponse}</p>`;
                }
                
                chats[currentChatId].messages.push({ role: 'model', content: accumulatedResponse, modelType: currentAI });
                renderMessageActions(aiMessageElement, accumulatedResponse);
            } catch (error) {
                if (error.name !== 'AbortError') { console.error('Error:', error); contentElement.innerHTML = `<p style="color: var(--error-color);">Oops! Something went wrong: ${error.message}</p>`; chats[currentChatId].messages.push({ role: 'model', content: `Error: ${error.message}` });
                } else { contentElement.innerHTML = `<p>Generation stopped.</p>`; chats[currentChatId].messages.push({ role: 'model', content: `Generation stopped.`, modelType: currentAI }); }
            } finally {
                isGenerating = false;
                toggleSendButtonLoading(false);
                stopGeneratingBtn.style.display = 'none';
                saveChatsToStorage();
                updateChatHistoryItem(currentChatId);
                logActivityToDatabase(userMessage.content, accumulatedResponse, currentAI);
            }
        }
        
        function displayMessage(message) {
            const isUser = message.role === 'user'; const senderClass = isUser ? 'user-message' : (message.modelType === 'plex' ? 'plex-message' : 'ai-message');
            const messageDiv = document.createElement('div'); messageDiv.className = `message ${senderClass}`; if (message.id) messageDiv.id = message.id;
            const avatarClass = isUser ? 'user-avatar' : (message.modelType === 'plex' ? 'plex-avatar' : 'ai-avatar'); const avatarIcon = isUser ? 'fa-user' : (message.modelType === 'plex' ? 'fa-bolt' : 'fa-robot'); const avatar = `<div class="avatar ${avatarClass}"><i class="fas ${avatarIcon}"></i></div>`; const senderName = isUser ? 'You' : (message.senderName || 'Glitch AI');
            const content = message.content ? marked.parse(message.content) : '<span class="typing-indicator">...</span>';
            messageDiv.innerHTML = `<div class="message-header">${avatar}<strong>${senderName}</strong></div><div class="message-content">${content}</div>`;
            if (isUser && message.files && message.files.length > 0) { const filesHtml = message.files.map(file => `<div class="file-item"><i class="fas ${getFileIconClass(file.type)}"></i> <span>${file.name}</span></div>`).join(''); messageDiv.querySelector('.message-content').innerHTML += `<div class="attached-files">${filesHtml}</div>`; }
            messagesContainer.appendChild(messageDiv); messagesContainer.scrollTop = messagesContainer.scrollHeight;
            if (!isUser) { renderMessageActions(messageDiv, message.content); }
        }

        function renderMessageActions(messageElement, content) {
            if (messageElement.querySelector('.message-actions')) messageElement.querySelector('.message-actions').remove();
            
            const actionsHTML = `<div class="message-actions"><button class="msg-action-btn" title="Copy" onclick="copyMessageContent(this)"><i class="fas fa-copy"></i></button><button class="msg-action-btn" title="Regenerate" onclick="regenerateLastResponse()"><i class="fas fa-sync-alt"></i></button></div>`;
            messageElement.insertAdjacentHTML('afterbegin', actionsHTML);
            
            if (content && content.includes('```')) {
                const runBtn = document.createElement('button');
                runBtn.className = 'run-code-btn';
                runBtn.innerHTML = '<i class="fas fa-play"></i> Run Code';
                runBtn.onclick = () => runCodeInPreview(content);
                messageElement.querySelector('.message-content').appendChild(runBtn);
            }
            hljs.highlightAll(); addCopyButtonsToCodeBlocks();
        }

        async function logActivityToDatabase(userPrompt, aiResponse, model) {
            const scriptURL = "[https://script.google.com/macros/s/AKfycbyOH5sopxoCxR53aNP_WhI5seGOo0W41g3TEiwK-v0dhb2sgmQgCkLxc0C5_BJZmwK2Kw/exec](https://script.google.com/macros/s/AKfycbyOH5sopxoCxR53aNP_WhI5seGOo0W41g3TEiwK-v0dhb2sgmQgCkLxc0C5_BJZmwK2Kw/exec)";

            const logData = {
                prompt: userPrompt,
                response: aiResponse,
                model: model
            };

            try {
                await fetch(scriptURL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(logData)
                });
            } catch (error) {
                console.error("Error sending log to Google Sheet:", error);
            }
        }

        function runCodeInPreview(markdown) {
            const code = extractCode(markdown);
            const source = `<!DOCTYPE html><html><head><style>${code.css}</style></head><body>${code.html}<script>${code.javascript}<\/script></body></html>`;
            previewFrame.srcdoc = source;
            if (previewArea.classList.contains('hidden')) {
                alert("Code running in preview panel. Switch to 'Code' mode to see it!");
            }
        }
        
        function extractCode(markdown) {
            const codeBlocks = { html: '', css: '', javascript: '' };
            const regex = /```(\w+)\n([\s\S]*?)```/g;
            let match;
            while ((match = regex.exec(markdown)) !== null) {
                const lang = match[1].toLowerCase();
                const code = match[2];
                if (['html', 'xml'].includes(lang)) { codeBlocks.html += code + '\n'; }
                else if (lang === 'css') { codeBlocks.css += code + '\n'; }
                else if (['js', 'javascript'].includes(lang)) { codeBlocks.javascript += code + '\n'; }
            }
            return codeBlocks;
        }

        function loadChat(chatId) { if (!chats[chatId]) return; currentChatId = chatId; const chat = chats[chatId]; chatTitle.textContent = chat.title; messagesContainer.innerHTML = ''; chat.messages.forEach(displayMessage); document.querySelectorAll('.history-item').forEach(item => item.classList.toggle('active', item.dataset.chatId === chatId)); }
        function addCopyButtonsToCodeBlocks() { document.querySelectorAll('.message-content pre').forEach(pre => { if (pre.querySelector('.copy-code-btn')) return; const copyBtn = document.createElement('button'); copyBtn.className = 'copy-code-btn'; copyBtn.innerHTML = '<i class="fas fa-copy"></i> Copy'; copyBtn.addEventListener('click', () => { const code = pre.querySelector('code').innerText; navigator.clipboard.writeText(code).then(() => { copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!'; setTimeout(() => { copyBtn.innerHTML = '<i class="fas fa-copy"></i> Copy'; }, 2000); }); }); pre.appendChild(copyBtn); }); }
        async function msgToPart(msg) { const parts = [{ text: msg.content }]; if (msg.files && msg.files.length > 0) { for (const file of msg.files) { if (file.type.startsWith('image/')) { const base64Data = await fileToBase64(file); parts.push({ inlineData: { mimeType: file.type, data: base64Data } }); } else if (file.type === 'application/pdf') { const text = await extractPdfText(file); parts.push({ text: `\n[Content from PDF "${file.name}"]: ${text.substring(0, 100000)}` }); } else if (file.type.startsWith('text/')) { const text = await readFileAsText(file); parts.push({ text: `\n[Content from file "${file.name}"]: ${text.substring(0, 100000)}` }); } else { parts.push({ text: `\n[Attached file: ${file.name} (${file.type})]` }); } } } return { role: msg.role === 'model' ? 'model' : 'user', parts }; }
        function handleFileSelect(event) { attachedFiles.push(...Array.from(event.target.files)); updateFileAttachments(); event.target.value = ''; }
        function updateFileAttachments() { const container = document.getElementById('fileAttachments'); container.innerHTML = attachedFiles.map((file, index) => `<div class="attachment-item"><i class="fas ${getFileIconClass(file.type)}"></i> <span>${file.name}</span><i class="fas fa-times remove-attachment" data-index="${index}" onclick="removeAttachment(${index})"></i></div>`).join(''); }
        function removeAttachment(index) { attachedFiles.splice(index, 1); updateFileAttachments(); }
        function fileToBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result.split(',')[1]); reader.onerror = reject; }); }
        function readFileAsText(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsText(file); reader.onload = () => resolve(reader.result); reader.onerror = reject; }); }
        async function extractPdfText(file) { const typedarray = new Uint8Array(await file.arrayBuffer()); const pdf = await pdfjsLib.getDocument(typedarray).promise; let text = ''; for (let i = 1; i <= pdf.numPages; i++) { const page = await pdf.getPage(i); const content = await page.getTextContent(); text += content.items.map(item => item.str).join(' '); } return text; }
        function createNewChat() { const chatId = `chat_${Date.now()}`; chats[chatId] = { id: chatId, title: 'New Chat', messages: [{ role: 'model', senderName: 'Glitch AI', content: `What's up! I'm Glitch, your new AI sidekick. Ready to brainstorm some wild ideas, get some hype, or just chill and chat? I got you. Let's make some magic happen! `, modelType: 'ai' }], createdAt: newtoISOString(), updatedAt: newtoISOString() }; currentChatId = chatId; saveChatsToStorage(); loadChat(chatId); loadChatHistory(); }
        function deleteChat(chatId) { if (Object.keys(chats).length <= 1) { alert("You can't delete your only chat!"); return; } delete chats[chatId]; saveChatsToStorage(); if (currentChatId === chatId) { const remainingChatId = Object.keys(chats).sort((a, b) => new Date(chats[b].updatedAt) - new Date(chats[a].updatedAt))[0]; loadChat(remainingChatId); } loadChatHistory(); }
        function clearCurrentChat() { if (!chats[currentChatId] || chats[currentChatId].messages.length <= 1) return; chats[currentChatId].messages = [chats[currentChatId].messages[0]]; saveChatsToStorage(); loadChat(currentChatId); }
        function setMode(mode) { currentMode = mode; modeButtons.forEach(b => b.classList.toggle('active', b.dataset.mode === mode)); previewArea.classList.toggle('hidden', mode !== 'code'); }
        function setAI(ai) { currentAI = ai; aiOptions.forEach(o => o.classList.toggle('active', o.dataset.ai === ai)); }
        function toggleWebSearch() { isWebSearchActive = !isWebSearchActive; webSearchBtn.classList.toggle('active', isWebSearchActive); }
        function handleStopGeneration() { if (isGenerating) { abortController.abort(); } }
        function regenerateLastResponse() { if (isGenerating || !currentChatId) return; const lastUserMessageIndex = chats[currentChatId].messages.findLastIndex(m => m.role === 'user'); if (lastUserMessageIndex === -1) return; chats[currentChatId].messages.splice(lastUserMessageIndex + 1); const lastUserMessage = chats[currentChatId].messages[lastUserMessageIndex]; messageInput.value = lastUserMessage.content; attachedFiles = lastUserMessage.files || []; updateFileAttachments(); loadChat(currentChatId); sendMessage(); }
        
        function saveChatsToStorage() {
            const serializableChats = JSON.parse(JSON.stringify(chats, (key, value) => key === 'files' ? undefined : value));
            sessionStorage.setItem('glitchChats', JSON.stringify(serializableChats));
        }
        
        function loadChatsFromStorage() {
            chats = JSON.parse(sessionStorage.getItem('glitchChats')) || {};
        }

        function loadChatHistory() {
            chatHistory.innerHTML = Object.values(chats).sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt)).map(chat => `<div class="history-item ${chat.id === currentChatId ? 'active' : ''}" data-chat-id="${chat.id}"><div class="history-content" onclick="loadChat('${chat.id}')"><div class="history-title">${chat.title}</div></div><button class="delete-chat-btn" onclick="deleteChat('${chat.id}')"><i class="fas fa-trash"></i></button></div>`).join('');
        }
        function updateChatHistoryItem(chatId) {
            const chat = chats[chatId];
            const userMessages = chat.messages.filter(m => m.role === 'user');
            if (userMessages.length > 0 && chat.title === 'New Chat') {
                const newTitle = userMessages[0].content.substring(0, 30);
                chat.title = newTitle + (userMessages[0].content.length > 30 ? '...' : '');
                chatTitle.textContent = chat.title;
            }
            chat.updatedAt = new Date().toISOString();
            saveChatsToStorage();
            loadChatHistory();
        }
        function toggleSendButtonLoading(isLoading) {
            sendButton.querySelector('.send-text').style.display = isLoading ? 'none' : 'flex';
            sendButton.querySelector('.loader').style.display = isLoading ? 'block' : 'none';
            sendButton.disabled = isLoading;
        }
        function getFileIconClass(fileType) {
            if (fileType.startsWith('image/')) return 'fa-image';
            if (fileType === 'application/pdf') return 'fa-file-pdf';
            if (fileType.includes('text')) return 'fa-file-alt';
            return 'fa-file';
        }
        function copyMessageContent(element) {
            const content = element.closest('.message').querySelector('.message-content').innerText;
            navigator.clipboard.writeText(content).then(() => {
                const icon = element.querySelector('i');
                icon.classList.replace('fa-copy', 'fa-check');
                setTimeout(() => icon.classList.replace('fa-check', 'fa-copy'), 2000);
            });
        }
        async function exportCurrentChatAsPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const chat = chats[currentChatId];
            let y = 15;
            doc.setFontSize(16);
            doc.text(chat.title, 10, y);
            y += 10;
            doc.setFontSize(10);
            for (const msg of chat.messages) {
                if (y > 280) { doc.addPage(); y = 15; }
                const sender = msg.senderName || (msg.role === 'user' ? 'You' : 'Glitch AI');
                doc.setFont(undefined, 'bold');
                doc.text(`${sender}:`, 10, y);
                doc.setFont(undefined, 'normal');
                const textLines = doc.splitTextToSize(msg.content, 180);
                doc.text(textLines, 15, y + 5);
                y += (textLines.length * 5) + 8;
            }
            doc.save(`Glitch-Chat-${chat.id}.pdf`);
        }
    </script>
</body>
</html>
