<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J.A.R.V.I.S. HUD V2.30</title>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.6.347/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.18/mammoth.browser.min.js"></script>
    <style>
        /* (All CSS is identical to V2.17. No changes here) */
        /* --- 1. Global & Fonts --- */
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400&display=swap');
        :root {
            --primary-glow: #00ffff; --secondary-glow: #ff00ff;
            --warning-glow: #ffaa00; --danger-glow: #ff2200;
            --bg-color: #0d0a1f; --glass-bg: rgba(20, 15, 40, 0.7);
            --text-color: #e0e0e0; --text-secondary: #a0a0c0;
            --border-color: rgba(0, 255, 255, 0.3);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body {
            height: 100%; width: 100%; font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color); color: var(--text-color);
            overflow: hidden;
            background-image: linear-gradient(45deg, #1a0b2a, #0d0a1f);
            perspective: 1000px;
        }
        
        /* --- 2. Backgrounds & Overlays --- */
        #particle-background {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; overflow: hidden;
        }
        .particle {
            position: absolute; background: var(--primary-glow);
            border-radius: 50%; opacity: 0.5; width: 2px; height: 2px;
            box-shadow: 0 0 5px var(--primary-glow);
            animation: move 20s linear infinite;
        }
        @keyframes move {
            0% { transform: translateY(0) translateX(0); opacity: 0.5; }
            100% { transform: translateY(-100vh) translateX(10vw); opacity: 0; }
        }
        #scanlines {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1; pointer-events: none;
            background: linear-gradient(0deg, rgba(255, 255, 255, 0) 0, rgba(255, 255, 255, 0.03) 50%, rgba(255, 255, 255, 0) 50%);
            background-size: 100% 3px;
            animation: scanlines 5s linear infinite;
        }

        /* --- 3. HUD Panels & Boot Sequence --- */
        .hud-panel {
            background: var(--glass-bg); border: 1px solid var(--border-color);
            border-radius: 15px; backdrop-filter: blur(10px);
            padding: 1rem; box-shadow: 0 0 20px rgba(0, 255, 255, 0.2) inset;
            transition: all 0.5s ease; position: relative; overflow: hidden;
            opacity: 0; transform: translateY(20px) scale(0.98);
            animation: flicker 10s linear infinite;
        }
        .hud-panel::before, .hud-panel::after {
            content: ''; position: absolute; width: 2px; height: 0;
            background: var(--primary-glow); box-shadow: 0 0 10px var(--primary-glow);
            animation: scan-border 4s linear infinite;
        }
        .hud-panel::before { top: 0; left: 0; }
        .hud-panel::after { bottom: 0; right: 0; animation-delay: 2s; }
        @keyframes scan-border { 0% { height: 0; } 50% { height: 100%; } 100% { height: 0; opacity: 0; } }
        @keyframes flicker {
            0%, 100% { opacity: 1; } 50.0% { opacity: 1; } 50.1% { opacity: 0.9; }
            50.2% { opacity: 1; } 50.3% { opacity: 0.95; } 50.4% { opacity: 1; }
        }
        .booted { opacity: 1; transform: translateY(0) scale(1); }

        h1, h2, h3, h4 { font-family: 'Orbitron', sans-serif; color: var(--primary-glow); transition: all 0.5s ease; }
        h3 { border-bottom: 1px solid var(--border-color); padding-bottom: 5px; margin-bottom: 10px; }
        h4 { color: var(--text-secondary); margin-top: 10px; font-size: 0.9rem; }
        
        #main-title {
            font-size: 2.5rem; text-align: center;
            animation: glitch 5s linear infinite;
        }
        @keyframes glitch {
            0%, 100% { text-shadow: 0 0 10px var(--primary-glow); }
            49% { text-shadow: 0 0 10px var(--primary-glow); }
            50% { text-shadow: 2px 2px 10px var(--danger-glow), -2px -2px 10px var(--secondary-glow); }
            51% { text-shadow: 0 0 10px var(--primary-glow); }
        }

        /* --- 4. Combat Mode Theme --- */
        body.combat-mode {
            --primary-glow: #ff2200; --border-color: rgba(255, 34, 0, 0.3);
            --glass-bg: rgba(40, 15, 20, 0.7);
        }
        body.combat-mode .hud-panel { box-shadow: 0 0 20px rgba(255, 34, 0, 0.2) inset; }
        body.combat-mode .status-item, body.combat-mode .jarvis-message, body.combat-mode #text-input { border-color: var(--danger-glow); }
        body.combat-mode .control-button { border-color: var(--danger-glow); color: var(--danger-glow); text-shadow: 0 0 5px var(--danger-glow); box-shadow: 0 0 10px var(--danger-glow) inset, 0 0 10px var(--danger-glow); }
        body.combat-mode .control-button:hover { background-color: var(--danger-glow); color: var(--bg-color); }
        body.combat-mode .web-toggle { border-color: var(--danger-glow); background: rgba(255, 34, 0, 0.1); }
        body.combat-mode .web-toggle label { color: var(--danger-glow); }
        body.combat-mode .status-bar-inner { background: var(--danger-glow); box-shadow: 0 0 10px var(--danger-glow); }
        body.combat-mode #arc-reactor, body.combat-mode #suit-svg path { --primary-glow: var(--danger-glow); }

        /* --- 5. Main Layout --- */
        .jarvis-container { display: flex; height: 100vh; width: 100vw; padding: 1rem; gap: 1rem; }
        .side-panel { flex: 0 0 300px; display: flex; flex-direction: column; gap: 1rem; z-index: 10; transition: transform 0.1s ease-out; }
        .main-panel { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; transition: transform 0.1s ease-out; }
        .right-panel { flex: 0 0 300px; display: flex; flex-direction: column; gap: 1rem; z-index: 10; transition: transform 0.1s ease-out; }

        /* --- 6. Left Panel (Suit Status) --- */
        #suit-status-panel { flex-grow: 1; display: flex; flex-direction: column; }
        #suit-schematic { position: relative; display: flex; flex-direction: column; align-items: center; margin-bottom: 1rem; }
        #suit-svg { width: 100%; opacity: 0.3; position: absolute; top: 50px; z-index: 1; }
        #suit-svg path { stroke: var(--primary-glow); stroke-width: 0.5; fill: none; filter: drop-shadow(0 0 5px var(--primary-glow)); transition: all 0.5s ease; }
        #arc-reactor { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--primary-glow); background: radial-gradient(circle, var(--primary-glow) 0%, rgba(0,0,0,0) 60%); box-shadow: 0 0 20px var(--primary-glow), 0 0 40px var(--primary-glow), 0 0 60px var(--primary-glow) inset; margin: 1.5rem auto; animation: pulse 2s infinite ease-in-out; transition: all 0.5s ease; z-index: 2; }
        .status-bar { width: 100%; height: 20px; background: rgba(0,0,0,0.3); border: 1px solid var(--border-color); border-radius: 5px; padding: 2px; z-index: 2; }
        .status-bar-inner { height: 100%; width: 90%; background: var(--primary-glow); border-radius: 3px; box-shadow: 0 0 10px var(--primary-glow); transition: all 0.5s ease; }
        .status-text { display: flex; justify-content: space-between; font-size: 0.9rem; margin-top: 5px; z-index: 2; }
        .status-text span:first-child { color: var(--text-secondary); }
        .status-text span:last-child { font-weight: bold; }

        /* --- 7. Right Panel (System & Logistics) --- */
        #logistics-panel { flex-shrink: 0; }
        #dynamic-clock { font-size: 1.5rem; text-align: center; font-family: 'Orbitron'; }
        #dynamic-date { font-size: 0.9rem; text-align: center; color: var(--text-secondary); }
        #logistics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        #weather-temp { font-size: 1.5rem; font-family: 'Orbitron'; }
        #weather-desc { font-weight: bold; }
        #camera-panel { flex-grow: 1; display: flex; flex-direction: column; padding: 0; }
        #camera-feed { width: 100%; height: 100%; object-fit: cover; border-radius: 15px; transform: scaleX(-1); background: #000; }

        /* --- 8. Main Panel (Chat) --- */
        #core-container { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; justify-content: center; align-items: center; overflow: hidden; z-index: 1; border-radius: 15px; }
        #web-core { width: 300px; height: 300px; border-radius: 50%; background: radial-gradient(circle, var(--primary-glow) 0%, var(--bg-color) 70%); box-shadow: 0 0 30px var(--primary-glow), 0 0 60px var(--primary-glow), 0 0 90px var(--secondary-glow); animation: pulse 3s infinite ease-in-out; position: relative; opacity: 0.2; animation-play-state: paused; transition: all 0.5s ease; }
        body.combat-mode #web-core { background: radial-gradient(circle, var(--danger-glow) 0%, var(--bg-color) 70%); box-shadow: 0 0 30px var(--danger-glow), 0 0 60px var(--danger-glow), 0 0 90px var(--danger-glow); }
        #web-core.listening { animation-play-state: running; opacity: 0.4; }
        #web-core::before, #web-core::after { content: ''; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); border-radius: 50%; border: 2px solid var(--primary-glow); transition: all 0.5s ease; }
        body.combat-mode #web-core::before, body.combat-mode #web-core::after { border-color: var(--danger-glow); }
        #web-core::before { width: 400px; height: 400px; animation: spin 8s linear infinite; }
        #web-core::after { width: 500px; height: 500px; animation: spin 12s linear infinite reverse; }
        @keyframes pulse { 0% { transform: scale(0.9); } 50% { transform: scale(1); } 100% { transform: scale(0.9); } }
        @keyframes spin { from { transform: translate(-50%, -50%) rotate(0deg); } to { transform: translate(-50%, -50%) rotate(360deg); } }

        #chat-container { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; z-index: 2; }
        #message-display { flex-grow: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column-reverse; scrollbar-width: none; }
        #message-display::-webkit-scrollbar { display: none; }
        .chat-message { max-width: 80%; padding: 0.8rem 1.2rem; border-radius: 15px; margin-bottom: 1rem; white-space: pre-wrap; word-wrap: break-word; background: rgba(20, 15, 40, 0.7); backdrop-filter: blur(5px); }
        .user-message { background: var(--primary-glow); color: var(--bg-color); align-self: flex-end; border-bottom-right-radius: 0; font-weight: bold; }
        body.combat-mode .user-message { background: var(--danger-glow); }
        .jarvis-message { border: 1px solid var(--primary-glow); align-self: flex-start; border-bottom-left-radius: 0; }
        .jarvis-message.error { border-color: var(--danger-glow); color: var(--danger-glow); }
        .jarvis-message.status { border-color: var(--warning-glow); color: var(--warning-glow); font-style: italic; text-align: center; align-self: center; }
        .jarvis-message pre { background: #020a17; border: 1px solid var(--primary-glow); padding: 1em; border-radius: 5px; margin: 1em 0; overflow-x: auto; font-family: 'Courier New', Courier, monospace; color: #e0e0e0; }
        .jarvis-message code { font-family: 'Courier New', Courier, monospace; background: #020a17; padding: 2px 4px; border-radius: 3px; }
        .jarvis-message pre code { background: none; padding: 0; border-radius: 0; }
        .jarvis-message b, .jarvis-message strong { color: var(--primary-glow); font-weight: bold; }
        .jarvis-message i, .jarvis-message em { color: var(--secondary-glow); font-style: italic; }

        #input-area { display: flex; gap: 0.5rem; padding: 1rem; border-top: 1px solid var(--border-color); z-index: 5; background: var(--glass-bg); border-bottom-left-radius: 15px; border-bottom-right-radius: 15px; transition: all 0.5s ease; }
        #text-input { flex-grow: 1; padding: 0.8rem 1.2rem; background: rgba(0,0,0,0.5); border: 1px solid var(--primary-glow); border-radius: 50px; color: var(--text-color); font-size: 1rem; }
        #text-input:focus { outline: none; box-shadow: 0 0 15px var(--primary-glow); }

        .control-button { font-family: 'Orbitron', sans-serif; font-size: 1rem; padding: 0.8rem 1.2rem; border: 2px solid var(--primary-glow); background-color: transparent; color: var(--primary-glow); border-radius: 50px; cursor: pointer; transition: all 0.3s ease; text-shadow: 0 0 5px var(--primary-glow); box-shadow: 0 0 10px var(--primary-glow) inset, 0 0 10px var(--primary-glow); white-space: nowrap; }
        .control-button:hover { background-color: var(--primary-glow); color: var(--bg-color); box-shadow: 0 0 20px var(--primary-glow), 0 0 30px var(--primary-glow); }
        .control-button.active { background-color: #ff0000; border-color: #ff0000; box-shadow: 0 0 15px #ff0000; text-shadow: none; }
        #mute-button.active { background-color: var(--secondary-glow); border-color: var(--secondary-glow); }
        #clear-button, #upload-button { border-color: var(--warning-glow); color: var(--warning-glow); box-shadow: 0 0 10px var(--warning-glow) inset, 0 0 10px var(--warning-glow); }
        #clear-button:hover, #upload-button:hover { background-color: var(--warning-glow); }

        /* --- 9. Toggles --- */
        .toggle-group { display: flex; flex-direction: column; gap: 10px; }
        .toggle-container { display: flex; align-items: center; gap: 10px; padding: 10px; border-radius: 5px; border: 1px solid; cursor: pointer; }
        .toggle-container label { font-family: 'Orbitron'; font-weight: bold; cursor: pointer; }
        .danger-toggle { border-color: var(--danger-glow); background: rgba(255, 34, 0, 0.1); }
        .danger-toggle label { color: var(--danger-glow); }
        .web-toggle { border-color: var(--primary-glow); background: rgba(0, 255, 255, 0.1); }
        .web-toggle label { color: var(--primary-glow); }
        
        /* --- 10. Modals --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); justify-content: center; align-items: center; z-index: 200; }
        .modal-content { background: var(--glass-bg); padding: 2rem; border-radius: 15px; border: 1px solid var(--primary-glow); box-shadow: 0 0 30px var(--primary-glow); text-align: center; }
        body.combat-mode .modal-content { border-color: var(--danger-glow); box-shadow: 0 0 30px var(--danger-glow); }

        /* --- 11. Mini Player --- */
        #player-modal { z-index: 201; }
        #player-container { width: 480px; height: 320px; background: #000; border-radius: 10px; overflow: hidden; }
        #player-controls { display: flex; justify-content: center; gap: 1rem; margin-top: 1rem; }
        /* NEW: Smaller player buttons */
        #player-controls .control-button { font-size: 0.9rem; padding: 0.6rem 1rem; }
        
        /* --- 12. Self-Destruct Animation --- */
        #destruction-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9998; background: rgba(255, 0, 0, 0.3); animation: flashRed 0.2s linear infinite; }
        #destruction-overlay::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(0deg, rgba(255, 255, 255, 0) 0, rgba(255, 255, 255, 0.05) 50%, rgba(255, 255, 255, 0) 50%); background-size: 100% 4px; animation: scanlines 0.2s linear infinite; }
        #destruction-overlay.active { display: block; }
        body.self-destruct .jarvis-container { animation: vibrate 0.1s linear infinite; }
        @keyframes flashRed { 0%, 100% { background-color: rgba(255, 0, 0, 0.5); } 50%  { background-color: rgba(255, 255, 255, 0.3); } }
        @keyframes scanlines { from { background-position-y: 0; } to { background-position-y: 4px; } }
        @keyframes vibrate { 0% { transform: translate(2px, 1px); } 50% { transform: translate(-1px, -2px); } 100% { transform: translate(2px, 1px); } }
        /* --- 13. Responsive Media Queries --- */
        
        /* Tablet / Smaller Desktops (Reduce side panel width) */
        @media (max-width: 1200px) {
            .side-panel, .right-panel {
                flex: 0 0 250px; /* Make side panels a bit smaller */
            }
        }

        /* Mobile / Small Tablets (Stack everything vertically) */
        @media (max-width: 900px) {
            html, body {
                height: auto;
                overflow-x: hidden;
                overflow-y: auto; /* Allow scrolling on mobile */
                perspective: none; /* Disable 3D tilt on mobile */
            }
            .jarvis-container {
                flex-direction: column; /* Stack panels vertically */
                height: auto;
                width: 100%;
                overflow: visible;
                padding: 0.5rem;
                gap: 0.5rem;
            }
            .side-panel, .right-panel, .main-panel {
                flex: 1 1 auto; /* Let them grow as needed */
                width: 100%;
                transition: none; /* Disable boot/tilt transitions */
                transform: none !important; /* Disable parallax effect */
            }
            
            /* Allow main panel to shrink, but give chat priority */
            .main-panel {
                min-height: 80vh; /* Give chat area most of the screen */
                order: 2; /* Main panel in the middle */
            }
            .side-panel { order: 1; } /* Left panel on top */
            .right-panel { order: 3; } /* Right panel at the bottom */

            /* Fix panel-specific grow issues */
            #suit-status-panel { flex-grow: 0; }
            #camera-panel {
                flex-grow: 0;
                height: 300px; /* Give camera a fixed height */
            }
            #audit-panel { flex-grow: 0; }

            /* Make chat messages full width */
            .chat-message {
                max-width: 95%;
            }

            /* Make input area usable on mobile */
            #input-area {
                flex-wrap: wrap; /* Allow buttons to wrap */
                gap: 0.5rem;
                padding: 0.5rem;
            }
            #text-input {
                flex-basis: 100%; /* Text input takes full width */
                order: 3; /* Put it below the buttons */
                font-size: 1rem;
            }
            .control-button {
                flex-grow: 1; /* Make buttons share the top row */
                padding: 0.6rem 0.8rem;
                font-size: 0.9rem;
            }
            #mic-button, #upload-button, #send-button {
                order: 1;
            }
            
            /* Fix logistics grid */
            #logistics-grid {
                grid-template-columns: 1fr 1fr; /* Keep 2 columns, but 1fr is fine */
            }
            
            /* Fix suit schematic */
            #arc-reactor {
                width: 80px;
                height: 80px;
                margin: 1rem auto;
            }

            /* Make modals full-width */
            .modal-content {
                width: 90%;
                padding: 1rem;
            }
            #player-container {
                width: 100%;
                height: 250px; /* Adjust player for vertical screens */
            }
        }
    </style>
</head>
<body>
    
    <div id="particle-background"></div>
    <div id="scanlines"></div>

    <div class="jarvis-container">
        <div class="side-panel" id="left-panel">
            <div id="suit-status-panel" class="hud-panel" style="transition-delay: 0.1s;">
                <h3>MARK VII TACTICAL</h3>
                <div id="suit-schematic">
                    <svg id="suit-svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid meet">
                        <path d="M 50 10 L 70 20 L 75 40 L 65 60 L 50 70 L 35 60 L 25 40 L 30 20 Z M 50 10 L 50 30 M 70 20 L 55 30 M 30 20 L 45 30 M 50 30 L 50 70 M 50 45 L 60 40 L 75 40 M 50 45 L 40 40 L 25 40 M 50 55 L 65 60 M 50 55 L 35 60"/>
                    </svg>
                    <div id="arc-reactor"></div>
                </div>
                <h4>ENERGY LEVEL</h4>
                <div class="status-bar"><div id="energy-bar" class="status-bar-inner"></div></div>
                <h4>ARMOUR INTEGRITY</h4>
                <div class="status-bar"><div id="armour-bar" class="status-bar-inner"></div></div>
                <div class="status-text"><span>FLIGHT SYSTEMS:</span><span id="flight-status">OFFLINE</span></div>
                <div class="status-text"><span>WEAPON SYSTEMS:</span><span id="weapon-status">DISARMED</span></div>
                <div class="status-text"><span>SUIT STATUS:</span><span id="suit-status">STANDBY</span></div>
            </div>
            <div id="controls-panel" class="hud-panel" style="transition-delay: 0.3s;">
                <h3>CONTROLS</h3>
                <div class="control-group">
                    <button id="mute-button" class="control-button">MUTE</button>
                    <button id="clear-button" class="control-button">CLEAR CHAT</button>
                    <div class="toggle-group">
                        <div class="danger-toggle toggle-container">
                            <input type="checkbox" id="safety-toggle">
                            <label for="safety-toggle">DANGER: Safety Off</label>
                        </div>
                        <div class="web-toggle toggle-container">
                            <input type="checkbox" id="web-search-toggle" checked>
                            <label for="web-search-toggle">Web Search ON</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-panel hud-panel" id="main-panel" style="transition-delay: 0.2s;">
            <div id="core-container"> <div id="web-core"></div> </div>
            <div id="chat-container">
                <div id="message-display"></div>
                <div id="input-area">
                    <button id="mic-button" class="control-button">MIC</button>
                    <button id="upload-button" class="control-button">UPLOAD</button>
                    <input type="file" id="file-uploader" accept=".txt,.pdf,.doc,.docx,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/pdf" style="display: none;">
                    <input type="text" id="text-input" placeholder="Type your query to JARVIS...">
                    <button id="send-button" class="control-button">SEND</button>
                </div>
            </div>
        </div>
        
        <div class="right-panel" id="right-panel">
            <div id="logistics-panel" class="hud-panel" style="transition-delay: 0.4s;">
                <h3>LOGISTICS</h3>
                <div id="dynamic-clock">--:--:--</div>
                <div id="dynamic-date">---, --- --</div>
                <div id="logistics-grid">
                    <div class="status-item"> <h4>CPU</h4> <p id="cpu-stat">--%</p> </div>
                    <div class="status-item"> <h4>MEM</h4> <p id="mem-stat">--%</p> </div>
                </div>
                <div class="status-text">
                    <span>WEATHER (HOWRAH):</span>
                    <span id="weather-desc">LOADING...</span>
                </div>
                <div class="status-item" style="grid-column: span 2; text-align: center; margin-top: 5px;">
                    <p id="weather-temp">--°C</p>
                </div>
            </div>
            <div id="camera-panel" class="hud-panel" style="transition-delay: 0.5s;">
                <video id="camera-feed" autoplay playsinline></video>
            </div>
            <div id="audit-panel" class="hud-panel" style="transition-delay: 0.6s;">
                <h3>ACTION AUDIT LOG</h3>
                <div id="audit-log"></div>
            </div>
        </div>
    </div>

    <div id="confirmation-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>ACTION CONFIRMATION</h3> <p id="modal-message">...</p>
            <div class="modal-buttons">
                <button id="modal-allow-button" class="control-button">ALLOW</button>
                <button id="modal-deny-button" class="control-button">DENY</button>
            </div>
        </div>
    </div>
    <div id="player-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="player-title">Now Playing...</h3>
            <div id="player-container"></div>
            <div id="player-controls">
                <button id="player-rewind" class="control-button">« 10s</button>
                <button id="player-pause" class="control-button">PAUSE</button>
                <button id="player-forward" class="control-button">10s »</button>
                <button id="player-close" class="control-button">CLOSE</button>
            </div>
        </div>
    </div>
    <div id="destruction-overlay"></div>

    <script>
        // --- 1. Global Constants & State ---
        const GOOGLE_SEARCH_API_KEY = 'AIzaSyBm8SxGHDl9pkrDuZt_VgFQME9a3aRUeXY';
        const SEARCH_ENGINE_ID = 'd13b9c982e19f4ccf';
        const GOOGLE_SEARCH_URL = `https://www.googleapis.com/customsearch/v1?key=${GOOGLE_SEARCH_API_KEY}&cx=${SEARCH_ENGINE_ID}`;
        const SHARED_SECRET_TOKEN = "YOUR_SUPER_SECRET_TOKEN_HERE";
        
        if (window.pdfjsLib) {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.6.347/pdf.worker.min.js';
        }
        
        let ws; let recognition; let ytPlayer;
        let isRecording = false; let isMuted = false;
        let currentLang = "en-US"; let pendingAction = null; 
        let jarvisVoice = null; let hasUserInteracted = false;
        const welcomeMsg = "At your service sir. How may I serve you today?";

        document.addEventListener("DOMContentLoaded", () => {
            // --- 2. DOM Elements ---
            const allBootElements = document.querySelectorAll(".hud-panel");
            const micButton = document.getElementById("mic-button");
            const muteButton = document.getElementById("mute-button");
            const clearButton = document.getElementById("clear-button");
            const textInput = document.getElementById("text-input");
            const sendButton = document.getElementById("send-button");
            const safetyToggle = document.getElementById("safety-toggle");
            const webSearchToggle = document.getElementById("web-search-toggle");
            const messageDisplay = document.getElementById("message-display");
            const cpuStat = document.getElementById("cpu-stat");
            const memStat = document.getElementById("mem-stat");
            const auditLog = document.getElementById("audit-log");
            const confirmationModal = document.getElementById("confirmation-modal");
            const modalMessage = document.getElementById("modal-message");
            const modalAllowButton = document.getElementById("modal-allow-button");
            const modalDenyButton = document.getElementById("modal-deny-button");
            const webCore = document.getElementById("web-core");
            const uploadButton = document.getElementById("upload-button");
            const fileUploader = document.getElementById("file-uploader");
            const playerModal = document.getElementById("player-modal");
            const playerTitle = document.getElementById("player-title");
            const playerPause = document.getElementById("player-pause");
            const playerClose = document.getElementById("player-close");
            const playerRewind = document.getElementById("player-rewind"); // NEW
            const playerForward = document.getElementById("player-forward"); // NEW
            const destructionOverlay = document.getElementById("destruction-overlay");
            const cameraFeed = document.getElementById("camera-feed");
            const dynamicClock = document.getElementById("dynamic-clock");
            const dynamicDate = document.getElementById("dynamic-date");
            const energyBar = document.getElementById("energy-bar");
            const armourBar = document.getElementById("armour-bar");
            const flightStatus = document.getElementById("flight-status");
            const weaponStatus = document.getElementById("weapon-status");
            const suitStatus = document.getElementById("suit-status");
            const particleBg = document.getElementById("particle-background");
            const leftPanel = document.getElementById("left-panel");
            const mainPanel = document.getElementById("main-panel");
            const rightPanel = document.getElementById("right-panel");
            const weatherDesc = document.getElementById("weather-desc");
            const weatherTemp = document.getElementById("weather-temp");

            // --- 3. WebSocket Logic ---
            function connectWebSocket() {
                ws = new WebSocket("wss://venice-postpupillary-coaxially.ngrok-free.dev/ws");
                ws.onopen = () => {
                    addJarvisMessage(welcomeMsg, "status");
                    sendMessage({ type: "get_audit_log" });
                    sendMessage({ type: "get_system_stats" });
                    sendMessage({ type: "get_weather", location: "Howrah" });
                };
                ws.onmessage = (event) => {
                    const msg = JSON.parse(event.data);
                    switch (msg.type) {
                        case "llm_chunk": updateLastJarvisMessage(msg.text); break;
                        case "llm_end": renderMarkdown(); speak(getCurrentJarvisMessageText(), null); break;
                        case "ui_command": handleUICommand(msg.action, msg.params); break;
                        case "action_confirmation":
                            if (safetyToggle.checked) {
                                sendMessage({ type: "execute_action", token: SHARED_SECRET_TOKEN, action_data: msg.action_data });
                            } else {
                                pendingAction = msg.action_data;
                                modalMessage.textContent = `JARVIS wants to execute: ${pendingAction.action} (${JSON.stringify(pendingAction.params)})`;
                                confirmationModal.style.display = "flex";
                            }
                            break;
                        case "action_status":
                            alert(`Action ${msg.status}: ${msg.message}`);
                            if (msg.status === "success") { sendMessage({ type: "get_audit_log" }); }
                            break;
                        case "audit_log": updateAuditLog(msg.log); break;
                        case "clear_confirmation":
                            messageDisplay.innerHTML = "";
                            addJarvisMessage("History and file context cleared. How can I help you, Sir?", "status");
                            break;
                        case "system_stats":
                            cpuStat.textContent = `${msg.cpu}%`; memStat.textContent = `${msg.mem}%`;
                            break;
                        case "weather_update":
                            const weather = msg.data;
                            if (weather && weather.temp) {
                                weatherDesc.textContent = `${weather.desc.toUpperCase()}`;
                                weatherTemp.textContent = `${weather.temp.toFixed(0)}°C`;
                            } else {
                                weatherDesc.textContent = "WEATHER OFFLINE";
                                weatherTemp.textContent = "--°C";
                            }
                            break;
                        case "context_set_confirmation":
                            addJarvisMessage(`Sir, I have loaded "${msg.filename}" (${msg.char_count} chars). You may now ask me about it.`, "status");
                            break;
                        case "error": addJarvisMessage(`ERROR: ${msg.message}`, "error"); break;
                    }
                };
                ws.onclose = () => { addJarvisMessage("Status: Disconnected. Retrying...", "error"); setTimeout(connectWebSocket, 3000); };
                ws.onerror = (err) => { console.error("WebSocket Error:", err); };
            }
            function sendMessage(message) {
                if (ws && ws.readyState === WebSocket.OPEN) { ws.send(JSON.stringify(message)); }
            }

            // --- 4. Chat UI Functions ---
            function addUserMessage(text) {
                const msgEl = document.createElement("div");
                msgEl.className = "chat-message user-message";
                msgEl.textContent = text;
                messageDisplay.prepend(msgEl); messageDisplay.scrollTop = 0;
            }
            function addJarvisMessage(text, type = "normal") {
                const msgEl = document.createElement("div");
                msgEl.className = `chat-message jarvis-message ${type}`;
                msgEl.textContent = text;
                messageDisplay.prepend(msgEl); messageDisplay.scrollTop = 0;
            }
            let lastJarvisMessageEl = null;
            function updateLastJarvisMessage(chunk) {
                if (!lastJarvisMessageEl || !messageDisplay.contains(lastJarvisMessageEl)) {
                    lastJarvisMessageEl = document.createElement("div");
                    lastJarvisMessageEl.className = "chat-message jarvis-message";
                    messageDisplay.prepend(lastJarvisMessageEl);
                }
                lastJarvisMessageEl.textContent += chunk;
            }
            function getCurrentJarvisMessageText() { return lastJarvisMessageEl ? lastJarvisMessageEl.textContent : ""; }
            function renderMarkdown() {
                if (!lastJarvisMessageEl) return;
                let text = lastJarvisMessageEl.textContent;
                text = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                text = text.replace(/```(.*?)```/gs, (match, code) => {
                    const lang = code.match(/^[a-zA-Z]+\n/);
                    let codeContent = code;
                    if(lang) { codeContent = code.substring(lang[0].length); }
                    return `<pre><code>${codeContent.trim()}</code></pre>`;
                });
                text = text.replace(/`([^`]+?)`/g, '<code>$1</code>');
                text = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
                text = text.replace(/\*(.*?)\*/g, '<i>$1</i>');
                lastJarvisMessageEl.innerHTML = text;
            }
            function submitQuery(text) {
                if (!text.trim()) return;
                addUserMessage(text); textInput.value = "";
                lastJarvisMessageEl = null;
                sendMessage({
                    type: "text_query", text: text, lang: currentLang,
                    web_search_enabled: webSearchToggle.checked
                });
            }

            // --- 5. Speech Recognition (ASR) ---
            function setupSpeechRecognition() {
                window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!window.SpeechRecognition) { micButton.disabled = true; micButton.textContent = "ASR N/A"; return; }
                recognition = new SpeechRecognition();
                recognition.lang = currentLang; recognition.continuous = true; recognition.interimResults = true;
                recognition.onstart = () => { isRecording = true; micButton.classList.add("active"); webCore.classList.add("listening"); };
                recognition.onend = () => { isRecording = false; micButton.classList.remove("active"); webCore.classList.remove("listening"); };
                recognition.onresult = (event) => {
                    let final_transcript = "";
                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) { final_transcript += event.results[i][0].transcript; }
                    }
                    if (final_transcript) { submitQuery(final_transcript); }
                };
                recognition.onerror = (event) => { console.error("Speech Recognition Error:", event.error); };
            }

            // --- 6. Speech Synthesis (TTS) & Audio ---
            function loadVoices() {
                const voices = window.speechSynthesis.getVoices();
                jarvisVoice = voices.find(v => v.name.includes('Google UK English Male')) ||
                              voices.find(v => v.name.includes('Microsoft David')) ||
                              voices.find(v => v.lang.includes('en-GB') && v.name.includes('Male')) || null;
            }
            function speak(text, onEndCallback) {
                if (isMuted || !text || !text.trim() || !hasUserInteracted) {
                    if (onEndCallback) onEndCallback(); return;
                }
                window.speechSynthesis.cancel();
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = text;
                const textToSpeak = tempDiv.textContent || tempDiv.innerText || "";
                const utterance = new SpeechSynthesisUtterance(textToSpeak);
                if (jarvisVoice) { utterance.voice = jarvisVoice; }
                utterance.lang = "en-GB"; utterance.pitch = 0.9; utterance.rate = 1.0;
                if (onEndCallback) { utterance.onend = onEndCallback; }
                window.speechSynthesis.speak(utterance);
            }
            function unlockAudio() {
                if (hasUserInteracted) return;
                hasUserInteracted = true;
                webCore.classList.add("listening");
                setTimeout(() => webCore.classList.remove("listening"), 2000);
                speak(welcomeMsg, null);
                startCamera();
            }
            function playAudio(url) {
                if (isMuted || !hasUserInteracted) return;
                try {
                    const audio = new Audio(url);
                    audio.play().catch(e => console.error("Audio play failed:", e));
                } catch (e) { console.error("Error creating audio:", e); }
            }
            
            function handleUICommand(action, params) {
                if (action === "enter_combat_mode") {
                    const text = "Sir, initiating combat mode.";
                    addJarvisMessage(text, "status");
                    document.body.classList.add("combat-mode");
                    speak(text, () => { playAudio("/audio/combat_on.mp3"); });
                } else if (action === "exit_combat_mode") {
                    const text = "Disengaging combat mode, Sir.";
                    addJarvisMessage(text, "status");
                    document.body.classList.remove("combat-mode");
                    speak(text, () => { playAudio("/audio/combat_off.mp3"); });
                } else if (action === "play_song") {
                    const songName = params.song_name;
                    addJarvisMessage(`Searching YouTube for "${songName}"...`, "status");
                    findAndPlayVideo(songName);
                }
                else if (action === "self_destruct") {
                    const text = "Self-destruct sequence initiated. Stand by.";
                    addJarvisMessage(text, "status");
                    speak(text, () => {
                        document.body.classList.add("self-destruct");
                        destructionOverlay.classList.add("active");
                        playAudio("/audio/self_destruct.mp3");
                        
                        setTimeout(() => {
                            document.body.classList.remove("self-destruct");
                            destructionOverlay.classList.remove("active");
                            addJarvisMessage("...System reset. All functions back online, Sir.", "status");
                        }, 5000);
                    });
                }
            }

            // --- 7. YouTube Player ---
            window.onYouTubeIframeAPIReady = function() {
                ytPlayer = new YT.Player('player-container', {
                    height: '320', width: '480', videoId: '',
                    playerVars: { 'autoplay': 1, 'controls': 0, 'rel': 0 },
                    events: {
                        'onReady': (event) => { event.target.playVideo(); },
                        'onStateChange': (event) => {
                            if (event.data === YT.PlayerState.PLAYING) { playerPause.textContent = "PAUSE"; }
                            if (event.data === YT.PlayerState.PAUSED) { playerPause.textContent = "PLAY"; }
                        }
                    }
                });
            }
            // !! V2.18 PLAYER FIX
            async function findAndPlayVideo(songName) {
                const query = `youtube ${songName}`;
                const url = `${GOOGLE_SEARCH_URL}&q=${encodeURIComponent(query)}`;
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`Google API error: ${response.statusText}`);
                    const data = await response.json();
                    
                    if (data.items && data.items.length > 0) {
                        // Find the first result that is actually a YouTube video
                        const firstResult = data.items.find(item => item.link && (item.link.includes("youtube.com/watch?v=") || item.link.includes("youtu.be/")));
                        
                        if (!firstResult) throw new Error("No valid YouTube links in search results");
                        
                        const videoLink = firstResult.link;
                        // Robust regex to get video ID from any YouTube URL format
                        const videoIdMatch = videoLink.match(/(?:v=|\/embed\/|\.be\/)([a-zA-Z0-9_-]{11})/);
                        
                        if (videoIdMatch && videoIdMatch[1]) {
                            playVideoById(videoIdMatch[1], firstResult.title);
                        } else { addJarvisMessage(`Error: Could not parse a valid YouTube video ID from link: ${videoLink}`, "error"); }
                    } else { addJarvisMessage(`Error: No YouTube results found for "${songName}".`, "error"); }
                } catch (err) { addJarvisMessage(`Error searching for video: ${err.message}`, "error"); }
            }
            function playVideoById(videoId, title) {
                playerTitle.textContent = title;
                playerModal.style.display = "flex";
                ytPlayer.loadVideoById(videoId);
                ytPlayer.playVideo();
            }
            function closePlayer() { ytPlayer.stopVideo(); playerModal.style.display = "none"; }
            function togglePausePlayer() {
                const state = ytPlayer.getPlayerState();
                if (state === YT.PlayerState.PLAYING) { ytPlayer.pauseVideo(); }
                else { ytPlayer.playVideo(); }
            }
            // NEW: Player control functions
            function rewindPlayer() {
                if (ytPlayer && ytPlayer.getCurrentTime) {
                    const currentTime = ytPlayer.getCurrentTime();
                    ytPlayer.seekTo(currentTime - 10, true);
                }
            }
            function forwardPlayer() {
                if (ytPlayer && ytPlayer.getCurrentTime) {
                    const currentTime = ytPlayer.getCurrentTime();
                    ytPlayer.seekTo(currentTime + 10, true);
                }
            }
            playerPause.addEventListener("click", togglePausePlayer);
            playerClose.addEventListener("click", closePlayer);
            playerRewind.addEventListener("click", rewindPlayer); // NEW
            playerForward.addEventListener("click", forwardPlayer); // NEW

            // --- 8. Client-Side File Upload Logic ---
            uploadButton.addEventListener("click", () => { fileUploader.click(); });
            fileUploader.addEventListener("change", async (event) => {
                const file = event.target.files[0];
                if (!file) return;
                addJarvisMessage(`Reading "${file.name}"...`, "status");
                try {
                    let text = "";
                    if (file.name.endsWith(".txt")) {
                        text = await file.text();
                    } else if (file.name.endsWith(".pdf")) {
                        text = await readPdfFile(file);
                    } else if (file.name.endsWith(".docx")) {
                        text = await readDocxFile(file);
                    } else {
                        addJarvisMessage(`Error: File type not supported. Please upload .txt, .pdf, or .docx`, "error");
                        fileUploader.value = ""; return;
                    }
                    sendMessage({
                        type: "set_file_context",
                        filename: file.name,
                        content: text
                    });
                } catch (err) { addJarvisMessage(`Error reading file: ${err.message}`, "error"); }
                fileUploader.value = "";
            });
            function readPdfFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const pdf = await pdfjsLib.getDocument(data).promise;
                            let textContent = "";
                            for (let i = 1; i <= pdf.numPages; i++) {
                                const page = await pdf.getPage(i);
                                const text = await page.getTextContent();
                                textContent += text.items.map(s => s.str).join(" ") + "\n";
                            }
                            resolve(textContent);
                        } catch (err) { reject(err); }
                    };
                    reader.onerror = (err) => reject(err);
                    reader.readAsArrayBuffer(file);
                });
            }
            function readDocxFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const result = await mammoth.extractRawText({ arrayBuffer: e.target.result });
                            resolve(result.value);
                        } catch (err) { reject(err); }
                    };
                    reader.onerror = (err) => reject(err);
                    reader.readAsArrayBuffer(file);
                });
            }

            // --- 9. Event Listeners ---
            document.addEventListener("click", unlockAudio, {once: true});
            micButton.addEventListener("click", () => { if (isRecording) { recognition.stop(); } else { recognition.start(); } });
            sendButton.addEventListener("click", () => { submitQuery(textInput.value); });
            textInput.addEventListener("keydown", (event) => { if (event.key === "Enter") { submitQuery(textInput.value); } });
            muteButton.addEventListener("click", () => {
                isMuted = !isMuted; muteButton.classList.toggle("active", isMuted);
                muteButton.textContent = isMuted ? "UNMUTE" : "MUTE";
                if (isMuted) { window.speechSynthesis.cancel(); closePlayer(); }
            });
            clearButton.addEventListener("click", () => {
                messageDisplay.innerHTML = ""; lastJarvisMessageEl = null;
                sendMessage({ type: "clear_history" });
            });
            webSearchToggle.addEventListener('change', () => {
                const label = document.querySelector("label[for='web-search-toggle']");
                label.textContent = webSearchToggle.checked ? "Web Search ON" : "Web Search OFF";
            });
            modalAllowButton.addEventListener("click", () => {
                if (pendingAction) {
                    sendMessage({ type: "execute_action", token: SHARED_SECRET_TOKEN, action_data: pendingAction });
                    pendingAction = null; confirmationModal.style.display = "none";
                }
            });
            modalDenyButton.addEventListener("click", () => {
                sendMessage({ type: "deny_action" });
                pendingAction = null; confirmationModal.style.display = "none";
            });
            document.body.addEventListener("mousemove", (e) => {
                if (document.body.classList.contains("self-destruct")) return;
                const x = (window.innerWidth / 2 - e.pageX) / 50;
                const y = (window.innerHeight / 2 - e.pageY) / 50;
                leftPanel.style.transform = `translateX(${-x}px) translateY(${-y}px)`;
                mainPanel.style.transform = `translateX(${x/2}px) translateY(${y/2}px)`;
                rightPanel.style.transform = `translateX(${x}px) translateY(${y}px)`;
            });

            // --- 10. Helper Functions ---
            function updateAuditLog(logEntries) {
                auditLog.innerHTML = "";
                if (!logEntries || logEntries.length === 0) { return; }
                logEntries.forEach(entry => {
                    const entryEl = document.createElement("div");
                    entryEl.classList.add("log-entry");
                    if (entry.status !== "success") { entryEl.classList.add("fail"); }
                    entryEl.innerHTML = `
                        <p><strong>${entry.action}</strong> (${entry.status})</p>
                        <p style="font-size: 0.8em; color: var(--text-secondary);">Params: ${entry.params}</p>
                        <p class="timestamp">${entry.timestamp.split('T')[1].split('.')[0]}</p>`;
                    auditLog.appendChild(entryEl);
                });
            }
            
            // --- 11. Dynamic UI Functions ---
            function startCamera() {
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    navigator.mediaDevices.getUserMedia({ video: true })
                        .then(function(stream) {
                            cameraFeed.srcObject = stream;
                            cameraFeed.play();
                        })
                        .catch(function(err) { console.error("Error starting camera: ", err); });
                }
            }
            function updateClock() {
                const now = new Date();
                const time = now.toLocaleTimeString('en-US', { hour12: true });
                const date = now.toLocaleDateString('en-US', { weekday: 'short', month: 'long', day: 'numeric' });
                dynamicClock.textContent = time;
                dynamicDate.textContent = date;
            }
            function updateSuitStatus() {
                energyBar.style.width = `${85 + Math.random() * 10}%`;
                armourBar.style.width = `${98 + Math.random() * 2}%`;
                const flight = ["OFFLINE", "STANDBY", "READY"];
                const weapons = ["DISARMED", "STANDBY", "ARMED"];
                const suit = ["NOMINAL", "STANDBY", "CHARGING"];
                flightStatus.textContent = flight[Math.floor(Math.random() * flight.length)];
                weaponStatus.textContent = weapons[Math.floor(Math.random() * weapons.length)];
                suitStatus.textContent = suit[Math.floor(Math.random() * suit.length)];
            }
            function generateParticles() {
                for(let i=0; i<50; i++) {
                    let p = document.createElement("div");
                    p.className = "particle";
                    p.style.top = `${Math.random() * 100}%`;
                    p.style.left = `${Math.random() * 100}%`;
                    p.style.animationDelay = `-${Math.random() * 20}s`;
                    particleBg.appendChild(p);
                }
            }

            // --- 12. Initialization ---
            connectWebSocket();
            setupSpeechRecognition();
            window.speechSynthesis.onvoiceschanged = loadVoices;
            loadVoices();
            updateClock();
            updateSuitStatus();
            generateParticles();
            
            setInterval(updateClock, 1000);
            setInterval(updateSuitStatus, 3000);
            setInterval(() => { sendMessage({ type: "get_system_stats" }); }, 3000);
            setInterval(() => { sendMessage({ type: "get_weather", location: "Howrah" }); }, 600000);
            
            setTimeout(() => {
                allBootElements.forEach(el => el.classList.add("booted"));
            }, 100);
        });
    </script>
</body>

</html>

