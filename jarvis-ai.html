<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>J.A.R.V.I.S. HUD V3.1 - Vision Enabled</title>
    
    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.6.347/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.18/mammoth.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400&display=swap');
        :root {
            --primary-glow: #00ffff; --secondary-glow: #ff00ff;
            --warning-glow: #ffaa00; --danger-glow: #ff2200;
            --bg-color: #0d0a1f; --glass-bg: rgba(20, 15, 40, 0.7);
            --text-color: #e0e0e0; --text-secondary: #a0a0c0;
            --border-color: rgba(0, 255, 255, 0.3);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body {
            height: 100%; width: 100%; font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color); color: var(--text-color);
            overflow: hidden; 
            background-image: linear-gradient(45deg, #1a0b2a, #0d0a1f);
        }
        
        #particle-background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        .particle {
            position: absolute; background: var(--primary-glow); border-radius: 50%; opacity: 0.5; width: 2px; height: 2px;
            animation: move 20s linear infinite;
        }
        @keyframes move { 100% { transform: translateY(-100vh) translateX(10vw); opacity: 0; } }
        
        .hud-panel {
            background: var(--glass-bg); border: 1px solid var(--border-color); border-radius: 15px; backdrop-filter: blur(10px);
            padding: 1rem; box-shadow: 0 0 20px rgba(0, 255, 255, 0.2) inset;
            animation: flicker 10s linear infinite;
        }
        @keyframes flicker { 50% { opacity: 1; } 50.1% { opacity: 0.9; } 50.2% { opacity: 1; } }

        h1, h2, h3 { font-family: 'Orbitron', sans-serif; color: var(--primary-glow); }
        h3 { border-bottom: 1px solid var(--border-color); padding-bottom: 5px; margin-bottom: 10px; }

        body.combat-mode { --primary-glow: #ff2200; --border-color: rgba(255, 34, 0, 0.3); }
        
        .jarvis-container { display: flex; height: 100vh; width: 100vw; padding: 1rem; gap: 1rem; }
        .side-panel, .right-panel { flex: 0 0 300px; display: flex; flex-direction: column; gap: 1rem; z-index: 10; }
        .main-panel { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }

        #suit-schematic svg path { stroke: var(--primary-glow); fill: none; }
        #arc-reactor { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--primary-glow); box-shadow: 0 0 20px var(--primary-glow); margin: 1.5rem auto; animation: pulse 2s infinite; }
        @keyframes pulse { 50% { transform: scale(1.05); } }
        
        #chat-container { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; z-index: 2; }
        #message-display { flex-grow: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column-reverse; }
        .chat-message { max-width: 80%; padding: 0.8rem; border-radius: 15px; margin-bottom: 1rem; background: rgba(0,0,0,0.5); }
        .user-message { background: var(--primary-glow); color: #000; align-self: flex-end; }
        .jarvis-message { border: 1px solid var(--primary-glow); align-self: flex-start; }
        .jarvis-message.typing::after { content: '‚ñã'; animation: blink 0.7s infinite; }
        
        #input-area { display: flex; gap: 0.5rem; padding: 1rem; background: var(--glass-bg); border-radius: 15px; }
        #text-input { flex-grow: 1; padding: 0.8rem; background: rgba(0,0,0,0.5); border: 1px solid var(--primary-glow); color: white; border-radius: 50px; }
        .control-button { padding: 0.8rem; border: 2px solid var(--primary-glow); background: transparent; color: var(--primary-glow); border-radius: 50px; cursor: pointer; font-family: 'Orbitron'; }
        .control-button:hover { background: var(--primary-glow); color: black; }
        
        #camera-feed { width: 100%; border-radius: 15px; transform: scaleX(-1); background: #000; }
        
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 200; justify-content: center; align-items: center; }
        .modal-content { background: var(--glass-bg); padding: 2rem; border-radius: 15px; border: 1px solid var(--primary-glow); text-align: center; }

        @media (max-width: 900px) {
            .jarvis-container { flex-direction: column; padding: 0; }
            .side-panel, .right-panel { display: none; }
            #mobile-nav { display: flex; }
        }
        #mobile-nav { display: none; position: fixed; bottom: 0; width: 100%; background: #000; justify-content: space-around; padding: 10px; z-index: 100; border-top: 1px solid var(--primary-glow); }
        .nav-item { color: var(--text-secondary); font-family: 'Orbitron'; }
    </style>
</head>
<body>
    <div id="particle-background"></div>
    <div class="jarvis-container">
        <div class="side-panel" id="left-panel">
            <div class="hud-panel">
                <h3>STATUS</h3>
                <div id="suit-schematic"><div id="arc-reactor"></div></div>
                <div>ENERGY: <span id="energy-bar">98%</span></div>
            </div>
            <div class="hud-panel">
                <h3>CONTROLS</h3>
                <button id="mute-button" class="control-button">MUTE</button>
                <button id="clear-button" class="control-button">CLEAR</button>
            </div>
        </div>

        <div class="main-panel hud-panel" id="main-panel">
            <div id="chat-container">
                <div id="message-display"></div>
                <div id="input-area">
                    <button id="web-search-btn" class="control-button" title="Web Search">üåê</button>
                    <input type="text" id="text-input" placeholder="CMD...">
                    <button id="mic-button" class="control-button">MIC</button>
                    <button id="upload-button" class="control-button">UP</button>
                    <input type="file" id="file-uploader" accept=".txt,.pdf,.doc,.docx,.jpg,.jpeg,.png" style="display: none;">
                    <button id="send-button" class="control-button">SEND</button>
                </div>
            </div>
        </div>
        
        <div class="right-panel" id="right-panel">
            <div class="hud-panel">
                <h3>DATA</h3>
                <div id="dynamic-clock">--:--</div>
                <div id="weather-desc">LOADING...</div>
                <div id="cpu-stat">CPU: --%</div>
            </div>
            <div class="hud-panel"><video id="camera-feed" autoplay playsinline></video></div>
            <div class="hud-panel" id="audit-log" style="font-size: 0.8em; overflow-y: auto; height: 150px;"></div>
        </div>
    </div>

    <nav id="mobile-nav">
        <div class="nav-item" onclick="location.reload()">RELOAD</div>
    </nav>

    <div id="confirmation-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>CONFIRM ACTION</h3> <p id="modal-message">...</p>
            <button id="modal-allow-button" class="control-button">ALLOW</button>
            <button id="modal-deny-button" class="control-button">DENY</button>
        </div>
    </div>
    
    <div id="player-modal" class="modal-overlay">
        <div class="modal-content">
            <div id="player-container"></div>
            <button id="player-close" class="control-button">CLOSE</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        const firebaseConfig = {
          apiKey: "AIzaSyDA218WauVZNgqeMgiR_5H6TLYQB5HXZkY",
          projectId: "gamingodyssey-2e642",
          appId: "1:964191300629:web:4be869d43fd0afeb00321c"
        };
        const app = initializeApp(firebaseConfig);
        window.firebaseDb = { db: getFirestore(app), collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, limit };
        window.currentUserId = localStorage.getItem('jarvis_device_id') || 'device_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('jarvis_device_id', window.currentUserId);
    </script>

    <script>
        const SHARED_SECRET_TOKEN = "YOUR_SUPER_SECRET_TOKEN_HERE";
        let ws, recognition, ytPlayer, isMuted = false, webSearchEnabled = true, pendingAction = null;
        if (window.pdfjsLib) pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.6.347/pdf.worker.min.js';

        document.addEventListener("DOMContentLoaded", () => {
            const els = {
                msgDisplay: document.getElementById("message-display"),
                input: document.getElementById("text-input"),
                micBtn: document.getElementById("mic-button"),
                sendBtn: document.getElementById("send-button"),
                uploadBtn: document.getElementById("upload-button"),
                fileInput: document.getElementById("file-uploader"),
                modal: document.getElementById("confirmation-modal"),
                audit: document.getElementById("audit-log"),
                cam: document.getElementById("camera-feed"),
                webBtn: document.getElementById("web-search-btn")
            };

            function connectWS() {
                ws = new WebSocket("ws://localhost:8000/ws");
                ws.onopen = () => { addJarvisMsg("Online."); send({type:"get_system_stats"}); };
                ws.onmessage = (e) => {
                    const m = JSON.parse(e.data);
                    if(m.type === "llm_chunk") updateLastMsg(m.text);
                    else if(m.type === "llm_end") { renderMD(); speak(lastMsgText()); }
                    else if(m.type === "action_confirmation") { pendingAction = m.action_data; document.getElementById("modal-message").innerText = m.action_data.action; els.modal.style.display = "flex"; }
                    else if(m.type === "action_status") addJarvisMsg(`Action: ${m.status} - ${m.message}`);
                    else if(m.type === "ui_command") handleUI(m.action, m.params);
                    else if(m.type === "system_stats") document.getElementById("cpu-stat").innerText = `CPU: ${m.cpu}%`;
                    else if(m.type === "weather_update") document.getElementById("weather-desc").innerText = m.data.desc;
                };
                ws.onclose = () => setTimeout(connectWS, 3000);
            }
            function send(data) { if(ws && ws.readyState===1) ws.send(JSON.stringify(data)); }

            function addJarvisMsg(text) {
                const d = document.createElement("div"); d.className = "chat-message jarvis-message";
                d.innerHTML = marked.parse(text); els.msgDisplay.prepend(d);
            }
            let lastEl = null, currText = "";
            function updateLastMsg(chunk) {
                if(!lastEl) { lastEl = document.createElement("div"); lastEl.className = "chat-message jarvis-message typing"; els.msgDisplay.prepend(lastEl); currText=""; }
                currText += chunk; lastEl.innerText = currText;
            }
            function renderMD() { if(lastEl) { lastEl.innerHTML = marked.parse(currText); lastEl.classList.remove("typing"); lastEl=null; } }
            function lastMsgText() { return currText; }

            // Image Handler
            function addUserMsgImage(name, src) {
                const d = document.createElement("div"); d.className = "chat-message user-message";
                d.innerHTML = `<div>${name}</div><img src="${src}" style="max-width:200px;border-radius:10px;">`;
                els.msgDisplay.prepend(d);
            }

            els.fileInput.addEventListener("change", async (e) => {
                const f = e.target.files[0]; if(!f) return;
                if(f.type.startsWith("image/")) {
                    addJarvisMsg("Vision Core analyzing...");
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        const img = new Image();
                        img.onload = () => {
                            const cvs = document.createElement('canvas');
                            let w=img.width, h=img.height, max=800;
                            if(w>h && w>max) { h*=max/w; w=max; } else if(h>max) { w*=max/h; h=max; }
                            cvs.width=w; cvs.height=h;
                            cvs.getContext('2d').drawImage(img,0,0,w,h);
                            const data = cvs.toDataURL('image/jpeg', 0.7);
                            addUserMsgImage(f.name, data);
                            send({ type: "analyze_image", image: data.split(',')[1], text: "Describe this." });
                        };
                        img.src = ev.target.result;
                    };
                    reader.readAsDataURL(f);
                } else {
                    // Docs
                    let txt = "";
                    if(f.name.endsWith(".txt")) txt = await f.text();
                    else if(f.name.endsWith(".pdf")) {
                         const pdf = await pdfjsLib.getDocument(await f.arrayBuffer()).promise;
                         for(let i=1; i<=pdf.numPages; i++) txt += (await (await pdf.getPage(i)).getTextContent()).items.map(s=>s.str).join(" ");
                    }
                    send({type: "set_file_context", filename: f.name, content: txt});
                    addJarvisMsg(`Read ${f.name}`);
                }
                els.fileInput.value = "";
            });

            // UI & Commands
            function submit() {
                const t = els.input.value; if(!t) return;
                const d = document.createElement("div"); d.className="chat-message user-message"; d.innerText=t;
                els.msgDisplay.prepend(d); els.input.value="";
                send({type: "text_query", text: t, web_search_enabled: webSearchEnabled});
            }
            els.sendBtn.onclick = submit;
            els.input.onkeydown = (e) => { if(e.key==="Enter") submit(); };
            els.uploadBtn.onclick = () => els.fileInput.click();
            
            document.getElementById("modal-allow-button").onclick = () => {
                send({type: "execute_action", action_data: pendingAction, token: SHARED_SECRET_TOKEN});
                els.modal.style.display="none";
            };
            document.getElementById("modal-deny-button").onclick = () => {
                send({type: "deny_action"}); els.modal.style.display="none";
            };

            // Speech
            if(window.SpeechRecognition || window.webkitSpeechRecognition) {
                recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                recognition.continuous=false;
                recognition.onresult = (e) => { els.input.value = e.results[0][0].transcript; submit(); };
                els.micBtn.onclick = () => recognition.start();
            }

            function speak(txt) {
                if(isMuted) return;
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(txt.replace(/[*_`]/g, ""));
                window.speechSynthesis.speak(u);
            }
            document.getElementById("mute-button").onclick = () => isMuted = !isMuted;
            
            // Camera
            navigator.mediaDevices.getUserMedia({video:true}).then(s => els.cam.srcObject=s).catch(e=>console.log(e));
            
            // Log Sync
            if(window.firebaseDb) {
                const {db, collection, query, orderBy, onSnapshot, limit} = window.firebaseDb;
                onSnapshot(query(collection(db,"users",window.currentUserId,"audit_log"), orderBy("timestamp","desc"), limit(10)), s => {
                    els.audit.innerHTML = "";
                    s.forEach(d => { const div=document.createElement("div"); div.innerText=`${d.data().action} - ${d.data().status}`; els.audit.appendChild(div); });
                });
            }

            // Youtube
            window.onYouTubeIframeAPIReady = () => {};
            function handleUI(act, p) {
                if(act==="enter_combat_mode") document.body.classList.add("combat-mode");
                if(act==="exit_combat_mode") document.body.classList.remove("combat-mode");
                if(act==="play_song") {
                   fetch(`${GOOGLE_SEARCH_URL}&q=youtube ${p.song_name}`).then(r=>r.json()).then(d=>{
                       const id = d.items[0].link.match(/v=([a-zA-Z0-9_-]{11})/)[1];
                       document.getElementById("player-modal").style.display="flex";
                       new YT.Player('player-container', {videoId:id, playerVars:{'autoplay':1}});
                   });
                }
            }
            document.getElementById("player-close").onclick = () => { document.getElementById("player-modal").style.display="none"; document.getElementById("player-container").innerHTML=""; };

            setInterval(() => {
                document.getElementById("dynamic-clock").innerText = new Date().toLocaleTimeString();
                const p = document.createElement("div"); p.className="particle"; 
                p.style.left=Math.random()*100+"%"; p.style.top=Math.random()*100+"%";
                document.getElementById("particle-background").appendChild(p);
            }, 1000);

            connectWS();
        });
    </script>
</body>
</html>
