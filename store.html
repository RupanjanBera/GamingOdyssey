<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Gaming Odyssey - AI-Powered Store</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --primary-color: #3B82F6;
      --secondary-color: #8B5CF6;
      --background-color: #0F172A;
      --text-color: #E2E8F0;
      --card-background: #1E293B;
      --card-border: #334155;
      --font-family: 'Poppins', sans-serif;
      --shadow-glow: 0 0 10px rgba(59, 130, 246, 0.2);
      --shadow-glow-hover: 0 0 15px rgba(59, 130, 246, 0.4);
    }
    html { scroll-behavior: smooth; }
    body {
      font-family: var(--font-family);
      background-color: var(--background-color);
      background-image: radial-gradient(circle at 1% 1%, #1e293b 0.5px, transparent 0);
      background-size: 20px 20px;
      color: var(--text-color);
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
    }
    /* Custom scrollbar */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #0F172A; }
    ::-webkit-scrollbar-thumb { background-color: var(--primary-color); border-radius: 10px; border: 2px solid #0F172A; }

    .sidebar, .category-menu {
      background: linear-gradient(180deg, #1E293B 0%, var(--background-color) 100%);
      box-shadow: 2px 0 8px rgba(0, 0, 0, 0.3);
      transition: transform 0.3s ease-in-out;
    }
    .hero-bg {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1)), var(--background-color);
      position: relative;
      overflow: hidden;
      border-bottom: 1px solid var(--card-border);
    }
    .fade-in {
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94), transform 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }
    .fade-in.visible { opacity: 1; transform: translateY(0); }
    
    .submit-btn {
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      color: white;
      font-weight: 600;
      border-radius: 0.5rem;
      transition: transform 0.2s ease, box-shadow 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }
    .submit-btn:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
    }
    .submit-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }
    
    .product-card {
      background: var(--card-background);
      border: 1px solid var(--card-border);
      border-radius: 0.75rem;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    .product-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.4), var(--shadow-glow-hover);
    }
    .product-card img {
      width: 100%;
      height: 220px;
      object-fit: contain;
      transition: transform 0.3s ease;
    }
    .product-card:hover .product-image-container img { transform: scale(1.05); }

    .product-card-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1rem;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
    }
    .product-card:hover .product-card-overlay {
        opacity: 1;
        pointer-events: auto;
    }
    .overlay-btn {
        background: rgba(30, 41, 59, 0.8);
        border: 1px solid var(--card-border);
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: all 0.2s ease;
    }
    .overlay-btn:hover {
        background: var(--primary-color);
        transform: scale(1.1);
    }
    .overlay-btn.selected {
        background: var(--secondary-color);
        color: white;
    }
    .overlay-btn.wishlist-btn.selected {
        background: #ef4444; /* red-500 */
    }


    /* Product Detail Modal */
    #product-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(8px);
      z-index: 50; display: flex; justify-content: center; align-items: center;
      opacity: 0; transition: opacity 0.3s ease; pointer-events: none;
    }
    #product-overlay.visible { opacity: 1; pointer-events: auto; }
    .product-detail-content {
      background: var(--card-background); border: 1px solid var(--card-border);
      border-radius: 0.75rem; padding: 2rem; width: 90%; max-width: 1000px;
      max-height: 90vh; overflow-y: auto; position: relative;
      transform: scale(0.95); transition: transform 0.3s ease;
    }
    #product-overlay.visible .product-detail-content { transform: scale(1); }

    /* Star Rating Styles */
    .rating { display: flex; flex-direction: row-reverse; justify-content: flex-end; }
    .rating input { display: none; }
    .rating label { color: #94A3B8; font-size: 1.5rem; padding: 0 0.1rem; cursor: pointer; transition: all 0.2s ease; }
    .rating input:not(:checked) ~ label:hover, .rating input:not(:checked) ~ label:hover ~ label { color: #FBBF24; }
    .rating input:checked ~ label { color: #FBBF24; }
    
    .ai-content h3 { font-size: 1.25rem; font-weight: 600; color: var(--primary-color); margin-bottom: 0.5rem;}
    .ai-content ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1rem; }
    .ai-content li { margin-bottom: 0.5rem; }
    .ai-content p { color: #cbd5e1; }
    .ai-content table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    .ai-content th, .ai-content td { border: 1px solid var(--card-border); padding: 0.75rem; text-align: left; }
    .ai-content th { background-color: #2c3a4f; }
    .ai-content h4 { font-size: 1.1rem; font-weight: 600; color: var(--secondary-color); margin-top: 1.5rem; }

    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.8);
        backdrop-filter: blur(8px);
        z-index: 50;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 1rem;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
    }
    .modal-overlay.visible {
        opacity: 1;
        pointer-events: auto;
    }

    /* Custom select style */
    select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='1.5' stroke='%2394a3b8' class='w-6 h-6'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='m19.5 8.25-7.5 7.5-7.5-7.5' /%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 1.5em 1.5em;
        padding-right: 2.5rem;
    }
  </style>
</head>
<body class="min-h-screen">
  <div id="loader" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex justify-center items-center z-[100]"><div class="border-4 border-slate-700 border-l-primary-color rounded-full w-12 h-12 animate-spin"></div></div>

  <!-- Product Detail Overlay -->
  <div id="product-overlay">
    <div id="product-detail-content" class="product-detail-content">
      <button id="close-product-overlay" class="absolute top-4 right-4 bg-slate-700/50 w-9 h-9 rounded-full text-white hover:bg-red-500 transition-colors"><i class="fas fa-times"></i></button>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div>
          <div class="relative mb-4">
            <img id="product-image" src="" alt="Product Image" class="w-full h-96 object-contain rounded-lg bg-slate-900/50 p-4">
          </div>
          <div id="thumbnail-container" class="flex gap-2 justify-center"></div>
        </div>
        <div>
          <h2 id="product-name" class="text-3xl font-bold mb-2"></h2>
          <div id="product-price" class="text-3xl font-bold text-blue-400 mb-4"></div>
          <div id="product-rating" class="flex items-center gap-2 mb-4">
            <div id="average-stars" class="text-yellow-400"></div>
            <div id="review-count" class="text-sm text-slate-400"></div>
          </div>
          <div class="bg-slate-800/50 p-4 rounded-lg mb-4">
            <h4 class="font-semibold mb-2">Description</h4>
            <div id="product-description" class="text-slate-300 text-sm leading-relaxed prose"></div>
          </div>
          <div class="flex gap-4 mb-6">
            <button id="overlay-add-to-cart" class="submit-btn flex-1 py-3"><i class="fas fa-cart-plus mr-2"></i> Add to Cart</button>
            <a href="address.html" id="overlay-buy-now" class="submit-btn flex-1 py-3 text-center"><i class="fas fa-bolt mr-2"></i> Buy Now</a>
          </div>
          <div id="ai-insights-container" class="mt-4 pt-4 border-t border-slate-700">
            <button id="get-ai-insights-btn" class="submit-btn w-full py-3">âœ¨ Get AI-Powered Insights</button>
            <div id="ai-insights-content" class="mt-4 hidden ai-content"></div>
          </div>
        </div>
      </div>
      <div class="mt-8 pt-6 border-t border-slate-700">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Customer Reviews</h3>
            <button id="summarize-reviews-btn" class="submit-btn !py-2 !px-4 text-sm" style="display: none;">âœ¨ Summarize Reviews</button>
        </div>
        <div id="review-summary-container" class="ai-content mb-6 hidden bg-slate-800/50 p-4 rounded-lg"></div>
        <div id="reviews-list" class="space-y-4 mb-6"></div>
        <div class="bg-slate-800/50 p-4 rounded-lg">
          <h4 class="font-semibold mb-2">Write a Review</h4>
          <div class="rating mb-2">
            <input type="radio" id="star5" name="rating" value="5"><label for="star5" title="5 stars">â˜…</label>
            <input type="radio" id="star4" name="rating" value="4"><label for="star4" title="4 stars">â˜…</label>
            <input type="radio" id="star3" name="rating" value="3"><label for="star3" title="3 stars">â˜…</label>
            <input type="radio" id="star2" name="rating" value="2"><label for="star2" title="2 stars">â˜…</label>
            <input type="radio" id="star1" name="rating" value="1"><label for="star1" title="1 star">â˜…</label>
          </div>
          <textarea id="review-text" placeholder="Share your thoughts..." class="w-full bg-slate-900 border border-slate-600 rounded-md p-2 mb-2 text-white"></textarea>
          <button id="submit-review" class="submit-btn px-6 py-2">Submit Review</button>
        </div>
      </div>
    </div>
  </div>
  
  <div class="flex">
    <!-- Sidebar (Left Nav) -->
    <aside class="sidebar fixed top-0 left-0 h-full z-20 w-64 -translate-x-full md:translate-x-0">
      <div class="p-6">
        <h1 class="text-2xl font-bold text-white leading-relaxed">Gaming Odyssey</h1>
        <nav class="mt-10 space-y-2">
            <a href="index.html" class="flex items-center space-x-3 text-slate-300 font-semibold p-3 rounded-md hover:bg-slate-700/50"><i class="fas fa-home w-5"></i><span>Home</span></a>
            <a href="store.html" class="flex items-center space-x-3 p-3 rounded-md bg-blue-500/20 text-blue-400 font-semibold"><i class="fas fa-store w-5"></i><span>Store</span></a>
            <a href="tournaments.html" class="flex items-center space-x-3 text-slate-300 font-semibold p-3 rounded-md hover:bg-slate-700/50"><i class="fas fa-trophy w-5"></i><span>Tournaments</span></a>
        </nav>
      </div>
    </aside>

    <!-- Category Menu (Right Side) -->
    <aside id="category-menu" class="category-menu fixed top-0 right-0 h-full z-30 w-64 translate-x-full md:translate-x-0">
        <div class="p-6">
            <h2 class="text-xl font-bold text-white mb-6 flex items-center"><i class="fas fa-list-alt mr-2"></i> Categories</h2>
            <nav id="category-nav" class="space-y-2"></nav>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 md:ml-64 md:mr-64 transition-all duration-300 ease-in-out pb-24"> <!-- Added padding-bottom -->
      <header class="sticky top-0 bg-slate-900/80 backdrop-blur-md z-10 p-4 flex justify-between items-center md:justify-end border-b border-slate-700">
        <button id="hamburger" class="md:hidden text-blue-400 text-2xl"><i class="fas fa-bars"></i></button>
        <div class="flex items-center gap-4">
          <button id="category-toggle" class="md:hidden submit-btn !p-3"><i class="fas fa-filter"></i></button>
          <div class="relative">
            <button id="wishlist-btn" class="header-icon-group flex items-center gap-2"><i class="fas fa-heart text-red-400 text-lg"></i><span class="text-sm hidden md:inline">Wishlist</span><span id="wishlist-count-desktop" class="bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span></button>
            <div id="wishlist-menu" class="hidden absolute top-full right-0 mt-2 w-72 bg-card-background border border-card-border rounded-lg shadow-lg z-50">
                <!-- Wishlist content goes here -->
            </div>
          </div>
          <a href="cart.html" class="header-icon-group flex items-center gap-2"><i class="fas fa-shopping-cart text-blue-400 text-lg"></i><span class="text-sm hidden md:inline">Cart</span><span id="cart-count" class="bg-blue-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span></a>
        </div>
      </header>
      <section class="hero-bg py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-7xl mx-auto">
          <h1 class="text-4xl md:text-5xl font-bold text-white text-center mb-2">Our Digital Armory</h1>
          <p class="text-slate-400 text-center mb-8 max-w-2xl mx-auto">Find the perfect gear to conquer your virtual worlds. High-performance peripherals await.</p>
          <div class="bg-slate-800/50 p-4 rounded-lg flex flex-col md:flex-row items-center gap-4">
            <div class="relative w-full flex-grow">
              <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
              <input type="text" id="search-input" placeholder="Search for mice, keyboards, etc..." class="w-full pl-12 py-3 rounded-md bg-slate-900 border border-slate-700 focus:border-blue-500 focus:ring-blue-500/50 focus:ring-2 outline-none">
            </div>
            <button id="open-setup-builder-btn" class="submit-btn flex-shrink-0 !py-3 !px-5 w-full md:w-auto">âœ¨ AI Setup Builder</button>
          </div>
        </div>
      </section>
      <section class="py-16 px-4 sm:px-6 lg:px-8">
        <div class="flex justify-end mb-4 max-w-7xl mx-auto">
            <select id="sort-filter" class="bg-slate-800 border border-slate-700 rounded-md p-2">
                <option value="default">Sort By</option>
                <option value="price-low">Price: Low to High</option>
                <option value="price-high">Price: High to Low</option>
                <option value="rating-high">Rating: High to Low</option>
                <option value="name-asc">Alphabetical: A-Z</option>
            </select>
        </div>
        <div id="products-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 gap-8 max-w-7xl mx-auto"></div>
      </section>
      
      <!-- Footer -->
      <footer class="bg-slate-900 border-t border-slate-700 py-10 px-4 sm:px-6 lg:px-8">
        <div class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-8">
            <div>
                <h3 class="font-bold text-lg mb-4">Gaming Odyssey</h3>
                <p class="text-slate-400 text-sm">Your one-stop shop for the best gaming peripherals to elevate your play.</p>
                <div class="flex gap-4 mt-4">
                    <a href="#" class="text-slate-400 hover:text-white"><i class="fab fa-instagram"></i></a>
                    <a href="#" class="text-slate-400 hover:text-white"><i class="fab fa-youtube"></i></a>
                    <a href="#" class="text-slate-400 hover:text-white"><i class="fab fa-twitter"></i></a>
                </div>
            </div>
            <div>
                <h3 class="font-bold text-lg mb-4">Quick Links</h3>
                <ul class="space-y-2 text-sm">
                    <li><a href="#" class="text-slate-400 hover:text-white">Home</a></li>
                    <li><a href="#" class="text-slate-400 hover:text-white">About Us</a></li>
                    <li><a href="#" class="text-slate-400 hover:text-white">Contact</a></li>
                </ul>
            </div>
            <div>
                <h3 class="font-bold text-lg mb-4">Newsletter</h3>
                <p class="text-slate-400 text-sm mb-2">Get exclusive deals and updates.</p>
                <div class="flex"><input type="email" placeholder="Enter your email" class="w-full p-2 rounded-l-md bg-slate-800 border border-slate-700"><button class="bg-blue-600 px-4 rounded-r-md">Go</button></div>
            </div>
        </div>
        <div class="text-center text-slate-500 text-xs mt-8 pt-8 border-t border-slate-800">
            &copy; 2025 Gaming Odyssey. All Rights Reserved.
        </div>
      </footer>
    </main>
  </div>
  
  <!-- Comparison Tray -->
  <div id="comparison-tray" class="fixed bottom-[-100%] left-0 right-0 z-40 bg-slate-800/80 backdrop-blur-md shadow-lg transition-all duration-500 ease-in-out">
    <div class="max-w-7xl mx-auto p-4 flex justify-between items-center">
        <div class="flex items-center gap-4">
            <h4 class="text-lg font-semibold hidden md:block">Compare Products</h4>
            <div id="comparison-items" class="flex gap-2"></div>
        </div>
        <div class="flex gap-4">
            <button id="clear-comparison-btn" class="text-slate-400 hover:text-white">Clear</button>
            <button id="compare-now-btn" class="submit-btn px-6 py-2" disabled>Compare (0/4)</button>
        </div>
    </div>
  </div>

  <!-- Comparison Modal -->
  <div id="comparison-modal-overlay" class="modal-overlay">
      <div class="bg-card-background border border-card-border rounded-lg p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto relative">
          <button id="close-comparison-modal" class="absolute top-4 right-4 text-2xl w-8 h-8 rounded-full bg-slate-700/50 hover:bg-red-500">&times;</button>
          <h2 class="text-2xl font-bold mb-4">âœ¨ AI Product Comparison</h2>
          <div id="comparison-result" class="ai-content"></div>
      </div>
  </div>
  
  <!-- AI Setup Builder Modal -->
  <div id="setup-builder-overlay" class="modal-overlay">
      <div class="bg-card-background border border-card-border rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto relative">
          <button id="close-setup-builder-modal" class="absolute top-4 right-4 text-2xl w-8 h-8 rounded-full bg-slate-700/50 hover:bg-red-500">&times;</button>
          <div id="setup-builder-form-container">
              <h2 class="text-2xl font-bold mb-2">âœ¨ AI Setup Builder</h2>
              <p class="text-slate-400 mb-6">Answer a few questions and our AI will build the perfect setup for you.</p>
              <form id="setup-builder-form" class="space-y-4">
                  <div>
                      <label for="game-type" class="block mb-2 font-semibold">What type of games do you primarily play?</label>
                      <select id="game-type" class="w-full bg-slate-800 border border-slate-700 rounded-md p-2">
                          <option>Competitive FPS (CS:GO, Valorant)</option>
                          <option>Battle Royale (Fortnite, Apex Legends)</option>
                          <option>MOBA/Strategy (League of Legends, Dota 2)</option>
                          <option>RPG/MMORPG (World of Warcraft, Elden Ring)</option>
                          <option>A bit of everything</option>
                      </select>
                  </div>
                  <div>
                      <label for="priority" class="block mb-2 font-semibold">What's your main priority?</label>
                      <select id="priority" class="w-full bg-slate-800 border border-slate-700 rounded-md p-2">
                          <option>Raw Performance & Speed</option>
                          <option>Wireless Freedom</option>
                          <option>Aesthetics & RGB Lighting</option>
                          <option>Comfort for Long Sessions</option>
                      </select>
                  </div>
                  <button type="submit" class="submit-btn w-full !py-3">Build My Setup</button>
              </form>
          </div>
          <div id="setup-builder-result" class="hidden">
            <h2 class="text-2xl font-bold mb-4">âœ¨ Your AI-Curated Setup</h2>
            <div id="setup-result-content" class="space-y-4"></div>
            <button id="restart-setup-builder-btn" class="submit-btn w-full !py-3 mt-6">Start Over</button>
          </div>
      </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {

      const defaultProducts = [
        { id: "prod_1", name: "Razer DeathAdder V3 Pro", price: 149.99, category: "Mouse", description: "An ultra-lightweight, ergonomic esports mouse that offers a level of speed and control favored by top pros. Features Razer's Focus Pro 30K Optical Sensor for flawless tracking performance.", images: ["https://assets2.razerzone.com/images/pnx.assets/618c0b652d83f88d7c177c3851586a1f/razer-deathadder-v3-pro-white.png", "https://assets2.razerzone.com/images/pnx.assets/0a29243eae24a49c4a45053fd28003f0/500x500-deathadder-v3-pro-black.png"], isNew: true, rating: 4.8, reviews: 120 },
        { id: "prod_2", name: "Logitech G Pro X Superlight", price: 159.99, salePrice: 139.99, category: "Mouse", description: "Meticulously designed in collaboration with the worldâ€™s leading esports pros. Engineered to win, it's the pinnacle of our continued pursuit for the highest levels of performance.", images: ["https://resource.logitechg.com/w_692,c_lpad,ar_4:3,q_auto,f_auto,dpr_1.0/d_transparent.gif/content/dam/gaming/en/products/pro-x-superlight/pro-x-superlight-gallery-1.png"], rating: 4.9, reviews: 250 },
        { id: "prod_3", name: "SteelSeries Apex Pro TKL", price: 179.99, category: "Keyboard", description: "The world's fastest and most advanced keyboard performs effortlessly for all undertakings, whether you need the fastest keystrokes in gaming to destroy the competition, or deliberate presses for typing accuracy.", images: ["https://media.steelseriescdn.com/thumbs/filer_public/30/c5/30c5a7fc-4209-4359-99a3-2287e2f20530/buy_apex_pro_tkl_wireless_gallery_1.png__1850x800_q100_crop-scale_optimize_subsampling-2.png"], rating: 4.7, reviews: 95 },
        { id: "prod_4", name: "HyperX Cloud Alpha Wireless", price: 199.99, category: "Headset", description: "Get a massive 300 hours of battery life and play for over a week without the battery getting low. DTS Headphone:X Spatial Audio helps you pinpoint opponent locations.", images: ["https://media.kingston.com/hyperx/product/hx-product-headset-cloud-alpha-wireless-1-zm-lg.png"], isNew: true, rating: 4.6, reviews: 88 },
      ];
      
      let allProducts = [];
      let cart = JSON.parse(localStorage.getItem('cart')) || [];
      let wishlist = JSON.parse(localStorage.getItem('wishlist')) || [];
      let productReviews = JSON.parse(localStorage.getItem('productReviews')) || {};
      let comparisonList = [];
      
      const loader = document.getElementById('loader');
      const productsGrid = document.getElementById('products-grid');
      const searchInput = document.getElementById('search-input');
      const sortFilter = document.getElementById('sort-filter');
      const comparisonTray = document.getElementById('comparison-tray');
      const modals = document.querySelectorAll('.modal-overlay');

      // --- GEMINI API & UTILITIES ---
      const API_KEY = "AIzaSyCnjp4BRaQYNHLOQl9CUjz_re33RZg_5ok"; 

      function sanitizeAIResponse(response) {
        return response.replace(/```html/g, '').replace(/```/g, '').trim();
      }

      async function callGeminiAPI(prompt) {
          if (!API_KEY) {
              alert("Gemini API key is not set in the script. AI features will not work.");
              return "Error: API Key not set.";
          }
          const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
          
          try {
              const payload = { contents: [{ parts: [{ text: prompt }] }] };
              const response = await fetch(API_URL, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(payload)
              });
              if (!response.ok) {
                  const errorData = await response.json().catch(() => null); 
                  const errorMessage = errorData?.error?.message || `API request failed with status ${response.status}.`;
                  console.error("API Error Response:", errorData || await response.text());
                  throw new Error(errorMessage);
              }
              const result = await response.json();
              if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                 return result.candidates[0].content.parts[0].text;
              } else {
                 console.error("Invalid response structure from API:", result);
                 return "Sorry, the AI response was not in the expected format.";
              }
          } catch (error) {
              console.error("Gemini API call failed:", error);
              return `Sorry, the AI feature failed. Reason: ${error.message}`;
          }
      }

      async function getAIInsights(product) {
        const insightsBtn = document.getElementById('get-ai-insights-btn');
        const insightsContent = document.getElementById('ai-insights-content');
        insightsBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Analyzing...';
        insightsBtn.disabled = true;

        const prompt = `You are a gaming hardware expert. Analyze the following product for a serious gamer and provide a concise summary of its key pros and cons. Product Name: ${product.name}. Description: ${product.description}. Format the output as simple HTML using <h3> for titles and <ul> for lists. Keep it brief.`;
        const rawResponse = await callGeminiAPI(prompt);
        
        if (rawResponse.startsWith("Error:") || rawResponse.startsWith("Sorry,")) {
            alert(rawResponse);
            insightsBtn.innerHTML = 'âœ¨ Get AI-Powered Insights';
            insightsBtn.disabled = false;
            return;
        }
        
        insightsContent.innerHTML = sanitizeAIResponse(rawResponse);
        insightsBtn.style.display = 'none';
        insightsContent.style.display = 'block';
      }
      
      // --- CORE LOGIC ---
      function initializeApp() {
        loader.style.display = 'flex';
        if (!localStorage.getItem('products')) {
          localStorage.setItem('products', JSON.stringify(defaultProducts));
        }
        allProducts = JSON.parse(localStorage.getItem('products'));
        
        updateCounts();
        renderCategories();
        applyFiltersAndSort();
        
        setTimeout(() => loader.style.display = 'none', 500);
      }

      function updateCounts() {
        document.getElementById('cart-count').textContent = cart.reduce((s, i) => s + i.quantity, 0);
        document.getElementById('wishlist-count-desktop').textContent = wishlist.length;
      }

      function addToCart(productId, quantity = 1) {
        const product = allProducts.find(p => p.id === productId);
        if (!product) return;

        const existingItem = cart.find(item => item.id === productId);
        if (existingItem) {
          existingItem.quantity += quantity;
        } else {
          cart.push({ id: productId, name: product.name, price: product.salePrice || product.price, quantity: quantity, image: product.images[0] });
        }
      }

      function saveAndNotify(message) {
        localStorage.setItem('cart', JSON.stringify(cart));
        localStorage.setItem('wishlist', JSON.stringify(wishlist));
        updateCounts();
        renderWishlistMenu();
        alert(message);
      }

      // --- PRODUCT & CATEGORY RENDERING ---
      function renderProducts(productsToRender) {
        productsGrid.innerHTML = '';
        if (productsToRender.length === 0) {
          productsGrid.innerHTML = `<p class="col-span-full text-center text-slate-400">No products found.</p>`;
          return;
        }
        productsToRender.forEach((p, i) => {
          const card = document.createElement('div');
          card.className = 'product-card fade-in';
          card.style.transitionDelay = `${i * 50}ms`;
          card.dataset.productId = p.id;
          
          const priceHTML = p.salePrice ? `<p class="text-xl font-bold text-blue-400">$${p.salePrice.toFixed(2)}</p><p class="text-sm line-through text-slate-400">$${p.price.toFixed(2)}</p>` : `<p class="text-xl font-bold text-blue-400">$${p.price.toFixed(2)}</p>`;
          card.innerHTML = `
            <div class="product-image-container relative p-4 bg-slate-900/50 cursor-pointer">
              <img src="${p.images[0]}" alt="${p.name}" loading="lazy">
              <div class="product-card-overlay">
                  <button class="overlay-btn view-details-btn" title="View Details"><i class="fas fa-eye"></i></button>
                  <button class="overlay-btn wishlist-btn ${wishlist.includes(p.id) ? 'selected' : ''}" title="Add to Wishlist"><i class="fas fa-heart"></i></button>
                  <button class="overlay-btn compare-btn ${comparisonList.includes(p.id) ? 'selected' : ''}" title="Compare"><i class="fas fa-balance-scale"></i></button>
              </div>
            </div>
            <div class="p-4 flex flex-col flex-grow">
              <h3 class="font-semibold flex-grow">${p.name}</h3>
              <div class="flex justify-between items-center mt-2">
                <div class="flex items-baseline gap-2">${priceHTML}</div>
                <div class="flex items-center text-sm gap-1 text-yellow-400"><i class="fas fa-star"></i><span>${p.rating}</span></div>
              </div>
            </div>`;
          productsGrid.appendChild(card);
        });
        
        const observer = new IntersectionObserver((entries) => entries.forEach(e => {
            if (e.isIntersecting) { e.target.classList.add('visible'); observer.unobserve(e.target); }
        }), { threshold: 0.1 });
        document.querySelectorAll('.product-card.fade-in').forEach(c => observer.observe(c));
      }

      function renderCategories() {
          const categories = ['All Products', ...new Set(allProducts.map(p => p.category))];
          const nav = document.getElementById('category-nav');
          nav.innerHTML = categories.map(c => `<a href="#" class="block p-2 rounded-md ${c === 'All Products' ? 'bg-blue-500/20 text-blue-400' : 'text-slate-300'} hover:bg-slate-700/50" data-category="${c}">${c}</a>`).join('');
      }

      function applyFiltersAndSort(category = 'All Products') {
        const searchTerm = searchInput.value.toLowerCase();
        let filtered = allProducts;
        
        if (category !== 'All Products') {
            filtered = filtered.filter(p => p.category === category);
        }
        if (searchTerm) {
            filtered = filtered.filter(p => p.name.toLowerCase().includes(searchTerm));
        }
        
        const sortValue = sortFilter.value;
        switch(sortValue) {
          case 'price-low': filtered.sort((a,b) => (a.salePrice||a.price) - (b.salePrice||b.price)); break;
          case 'price-high': filtered.sort((a,b) => (b.salePrice||b.price) - (a.salePrice||a.price)); break;
          case 'rating-high': filtered.sort((a, b) => b.rating - a.rating); break;
          case 'name-asc': filtered.sort((a, b) => a.name.localeCompare(b.name)); break;
        }
        renderProducts(filtered);
      }

      // --- PRODUCT DETAIL MODAL ---
      function openProductOverlay(productId) {
          const product = allProducts.find(p => p.id === productId);
          if (!product) return;
          
          document.getElementById('product-name').textContent = product.name;
          document.getElementById('product-price').textContent = product.salePrice ? `$${product.salePrice.toFixed(2)}` : `$${product.price.toFixed(2)}`;
          document.getElementById('product-description').innerHTML = product.description; // Changed to innerHTML
          document.getElementById('product-image').src = product.images[0];
          
          document.getElementById('overlay-add-to-cart').onclick = () => {
              addToCart(product.id);
              saveAndNotify(`${product.name} added to cart!`);
          };
          document.getElementById('submit-review').onclick = () => submitReview(product.id);
          document.getElementById('get-ai-insights-btn').onclick = () => getAIInsights(product);
          document.getElementById('summarize-reviews-btn').onclick = () => getAIReviewSummary(product.id);
          
          const insightsBtn = document.getElementById('get-ai-insights-btn');
          const insightsContent = document.getElementById('ai-insights-content');
          insightsBtn.style.display = 'block';
          insightsBtn.innerHTML = 'âœ¨ Get AI-Powered Insights';
          insightsBtn.disabled = false;
          insightsContent.style.display = 'none';
          insightsContent.innerHTML = '';
          
          document.getElementById('review-summary-container').classList.add('hidden');
          document.getElementById('review-summary-container').innerHTML = '';


          loadProductReviews(product.id);
          
          const thumbnailContainer = document.getElementById('thumbnail-container');
          thumbnailContainer.innerHTML = product.images.map((img, index) => 
            `<img src="${img}" class="w-16 h-16 object-contain rounded-md cursor-pointer border-2 ${index === 0 ? 'border-blue-500' : 'border-transparent'}" data-index="${index}">`
          ).join('');
          
          document.getElementById('product-overlay').classList.add('visible');
      }
      
      function loadProductReviews(productId) {
        const reviews = productReviews[productId] || [];
        const averageRating = reviews.length ? (reviews.reduce((acc, r) => acc + r.rating, 0) / reviews.length) : 0;
        
        document.getElementById('average-stars').innerHTML = 'â˜…'.repeat(Math.round(averageRating)) + 'â˜†'.repeat(5 - Math.round(averageRating));
        document.getElementById('review-count').textContent = `(${reviews.length} reviews)`;
        
        const list = document.getElementById('reviews-list');
        list.innerHTML = ''; // Clear previous reviews

        if (reviews.length > 0) {
             list.innerHTML = reviews.map(r => `
              <div class="bg-slate-800/50 p-3 rounded-lg">
                <div class="flex justify-between items-center mb-1">
                  <p class="font-semibold">${'Anonymous'}</p>
                  <div class="text-yellow-400">${'â˜…'.repeat(r.rating)}</div>
                </div>
                <p class="text-sm text-slate-300">${r.text}</p>
              </div>
            `).join('');
        } else {
            list.innerHTML = `<div id="ai-persona-review-placeholder" class="text-center text-slate-400 p-4 border-2 border-dashed border-slate-600 rounded-lg">
                <p class="mb-2">No reviews yet for this product.</p>
                <button id="generate-persona-review-btn" data-product-id="${productId}" class="submit-btn !py-2 !px-4 text-sm">âœ¨ Generate AI Persona Review</button>
            </div>`;
        }
        
        const summarizeBtn = document.getElementById('summarize-reviews-btn');
        if (reviews.length >= 3) {
            summarizeBtn.style.display = 'block';
            summarizeBtn.innerHTML = 'âœ¨ Summarize Reviews';
            summarizeBtn.disabled = false;
        } else {
            summarizeBtn.style.display = 'none';
        }
      }
      
      function submitReview(productId) {
          const ratingInput = document.querySelector('input[name="rating"]:checked');
          const reviewText = document.getElementById('review-text').value.trim();
          if (!ratingInput || !reviewText) {
              alert('Please provide a rating and a review.');
              return;
          }
          if (!productReviews[productId]) productReviews[productId] = [];
          productReviews[productId].unshift({ rating: parseInt(ratingInput.value), text: reviewText });
          localStorage.setItem('productReviews', JSON.stringify(productReviews));
          loadProductReviews(productId);
          ratingInput.checked = false;
          document.getElementById('review-text').value = '';
      }

       async function getAIReviewSummary(productId) {
          const reviews = productReviews[productId] || [];
          if (reviews.length < 3) return;

          const summarizeBtn = document.getElementById('summarize-reviews-btn');
          const summaryContainer = document.getElementById('review-summary-container');

          summarizeBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Summarizing...';
          summarizeBtn.disabled = true;

          const reviewTexts = reviews.map(r => `- Rating: ${r.rating}/5. Review: "${r.text}"`).join('\n');
          const prompt = `You are a helpful e-commerce assistant. Based on the following customer reviews for a product, provide a concise summary. Identify the main positive themes and the main negative themes mentioned by the customers. Do not invent new information. Format your response as simple HTML with two <h3> headings: "Common Praise" and "Common Critiques", each followed by a <ul> list of the key points.\n\nReviews:\n${reviewTexts}`;

          const rawResponse = await callGeminiAPI(prompt);
          
          if (rawResponse.startsWith("Error:") || rawResponse.startsWith("Sorry,")) {
            alert(rawResponse);
            summarizeBtn.innerHTML = 'âœ¨ Summarize Reviews';
            summarizeBtn.disabled = false;
            return;
           }
          
          summaryContainer.innerHTML = sanitizeAIResponse(rawResponse);
          summaryContainer.classList.remove('hidden');
          summarizeBtn.style.display = 'none';
      }

       async function getAIPersonaReview(productId) {
          const placeholder = document.getElementById('ai-persona-review-placeholder');
          const btn = document.getElementById('generate-persona-review-btn');
          btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generating...';
          btn.disabled = true;

          const product = allProducts.find(p => p.id === productId);
          if (!product) return;

          const prompt = `You are a creative writer and an expert on gaming hardware. Your task is to write a plausible, first-person product review from the perspective of a specific type of gamer.
            Product Name: ${product.name}
            Category: ${product.category}
            Description: ${product.description}
            Based on the product details, determine the most likely target audience (e.g., competitive FPS player, casual RPG fan, streamer) and write a product review from their perspective. The review should sound authentic and mention specific (plausible) experiences with the product.
            Please respond with ONLY a valid JSON object in this exact format, with no extra text or markdown: {"rating": 5, "persona": "Competitive FPS Player", "text": "The review text goes here..."}`;
          
          const response = await callGeminiAPI(prompt);
          
          if (response.startsWith("Error:") || response.startsWith("Sorry,")) {
              console.error("AI Persona Review failed:", response);
              placeholder.innerHTML = `<p class="text-red-400">${response}</p>`;
              return;
          }

          try {
              const review = JSON.parse(response);
              const reviewHTML = `
                <div class="bg-indigo-900/50 p-4 rounded-lg border border-indigo-700">
                  <div class="flex justify-between items-center mb-2">
                    <div class="font-semibold flex items-center gap-2">
                      <i class="fas fa-robot text-indigo-400"></i>
                      <span>AI Persona Review (${review.persona})</span>
                    </div>
                    <div class="text-yellow-400">${'â˜…'.repeat(review.rating)}${'â˜†'.repeat(5 - review.rating)}</div>
                  </div>
                  <p class="text-sm text-indigo-200">${review.text}</p>
                </div>
              `;
              document.getElementById('reviews-list').innerHTML = reviewHTML;
          } catch(e) {
              console.error("Failed to parse AI persona review:", e);
              placeholder.innerHTML = `<p class="text-red-400">Sorry, the AI couldn't generate a review right now. Please try again later.</p>`;
          }
       }

      
      // --- WISHLIST LOGIC ---
        function toggleWishlist(productId) {
            const index = wishlist.indexOf(productId);
            if (index > -1) {
                wishlist.splice(index, 1);
            } else {
                wishlist.push(productId);
            }
            localStorage.setItem('wishlist', JSON.stringify(wishlist));
            updateCounts();
            applyFiltersAndSort(document.querySelector('#category-nav a.bg-blue-500\/20')?.dataset.category || 'All Products');
            renderWishlistMenu();
        }

        function renderWishlistMenu() {
            const menu = document.getElementById('wishlist-menu');
            if (wishlist.length === 0) {
                menu.innerHTML = `<div class="p-4 text-center text-slate-400">Your wishlist is empty.</div>`;
                return;
            }

            const itemsHTML = wishlist.map(id => {
                const product = allProducts.find(p => p.id === id);
                return `<div class="flex items-center gap-2 p-2 hover:bg-slate-700/50">
                    <img src="${product.images[0]}" class="w-10 h-10 object-contain rounded">
                    <div class="flex-grow"><p class="text-sm truncate">${product.name}</p></div>
                    <button class="remove-wishlist-item-btn text-red-400 hover:text-red-600" data-id="${id}">&times;</button>
                </div>`;
            }).join('');
            
            menu.innerHTML = `
                <div id="wishlist-menu-items" class="max-h-60 overflow-y-auto">${itemsHTML}</div>
                <div class="p-2 border-t border-slate-700 space-y-2">
                    <button id="wishlist-add-all-to-cart" class="w-full text-center bg-blue-600 hover:bg-blue-700 text-white text-sm py-2 rounded">Add All to Cart</button>
                    <button id="wishlist-buy-all" class="w-full text-center bg-green-600 hover:bg-green-700 text-white text-sm py-2 rounded">Buy All Items</button>
                    <button id="wishlist-clear" class="w-full text-center bg-red-600 hover:bg-red-700 text-white text-sm py-2 rounded">Clear Wishlist</button>
                </div>
            `;
        }

      // --- COMPARISON LOGIC ---
        function toggleCompare(productId) {
            const index = comparisonList.indexOf(productId);
            if (index > -1) {
                comparisonList.splice(index, 1);
            } else {
                if (comparisonList.length < 4) {
                    comparisonList.push(productId);
                } else {
                    alert('You can compare a maximum of 4 products.');
                }
            }
            updateComparisonTray();
        }

        function updateComparisonTray() {
            if (comparisonList.length > 0) {
                comparisonTray.style.bottom = '0';
            } else {
                comparisonTray.style.bottom = '-100%';
            }

            const itemsContainer = document.getElementById('comparison-items');
            itemsContainer.innerHTML = comparisonList.map(id => {
                const product = allProducts.find(p => p.id === id);
                return `<img src="${product.images[0]}" title="${product.name}" class="w-12 h-12 object-contain rounded-md bg-slate-700">`;
            }).join('');

            const compareBtn = document.getElementById('compare-now-btn');
            compareBtn.textContent = `Compare (${comparisonList.length}/4)`;
            compareBtn.disabled = comparisonList.length < 2;
            
            document.querySelectorAll('.compare-btn').forEach(btn => {
                const card = btn.closest('.product-card');
                if (comparisonList.includes(card.dataset.productId)) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            });
        }
        
        async function getAIComparison() {
            const modal = document.getElementById('comparison-modal-overlay');
            const resultContainer = document.getElementById('comparison-result');
            modal.classList.add('visible');
            resultContainer.innerHTML = '<div class="flex justify-center items-center gap-2"><i class="fas fa-spinner fa-spin"></i>Generating comparison...</div>';

            const productsToCompare = comparisonList.map(id => allProducts.find(p => p.id === id));
            const productDetails = productsToCompare.map(p => `Name: ${p.name}, Price: $${p.salePrice || p.price}, Description: ${p.description}`).join('\n\n');

            const prompt = `You are a gaming hardware expert. Create a detailed comparison for a competitive gamer based on the following products:\n\n${productDetails}\n\nYour response must be in HTML format. Generate a <table> that compares key features (like sensor, weight for mice; switch type for keyboards; battery life, connection for headsets). After the table, add an <h4> titled "Expert Recommendation" and write a paragraph recommending which product is best for different types of gamers (e.g., "The Razer Deathadder is best for FPS players who value low weight...").`;
            
            const rawResponse = await callGeminiAPI(prompt);

            if (rawResponse.startsWith("Error:") || rawResponse.startsWith("Sorry,")) {
                modal.classList.remove('visible');
                return;
            }

            resultContainer.innerHTML = sanitizeAIResponse(rawResponse);
        }

      // --- AI SETUP BUILDER ---
        async function handleSetupBuilderSubmit(e) {
            e.preventDefault();
            const formContainer = document.getElementById('setup-builder-form-container');
            const resultContainer = document.getElementById('setup-builder-result');
            const result_content = document.getElementById('setup-result-content');
            
            formContainer.style.display = 'none';
            resultContainer.style.display = 'block';
            result_content.innerHTML = '<div class="flex justify-center items-center gap-2"><i class="fas fa-spinner fa-spin"></i>Building your perfect setup...</div>';
            
            const gameType = document.getElementById('game-type').value;
            const priority = document.getElementById('priority').value;

            const availableProducts = JSON.stringify(allProducts.map(p => ({id: p.id, name: p.name, category: p.category, description: p.description})));
            const prompt = `You are an expert gaming setup curator. A user needs a complete setup (one mouse, one keyboard, one headset). Their preferences are: \n- Primary Games: ${gameType}\n- Main Priority: ${priority}\n\nFrom the following JSON list of available products, select the single best mouse, keyboard, and headset for this user. \n\nProducts: ${availableProducts}\n\nPlease respond with ONLY a valid JSON object in this exact format, with no extra text or markdown: {"mouse": {"id": "product_id", "reason": "brief explanation"}, "keyboard": {"id": "product_id", "reason": "brief explanation"}, "headset": {"id": "product_id", "reason": "brief explanation"}, "summary": "A brief overall summary of why this setup is a great match."}`;
            
            const response = await callGeminiAPI(prompt);
            
            if (response.startsWith("Error:") || response.startsWith("Sorry,")) {
                console.error("AI Setup builder failed:", response);
                result_content.innerHTML = `<p class="text-red-400">${response}</p>`;
                return;
            }

            try {
                const recommendations = JSON.parse(response);
                displaySetupResults(recommendations);
            } catch (error) {
                console.error("Failed to parse AI setup response:", error);
                result_content.innerHTML = `<p class="text-red-400">Sorry, there was an error generating your setup. The AI's response was not in the correct format. Please try again.</p>`;
            }
        }
        
        function displaySetupResults(recs) {
            const content = document.getElementById('setup-result-content');
            content.innerHTML = ''; // Clear spinner
            
            ['mouse', 'keyboard', 'headset'].forEach(category => {
                if (recs[category] && recs[category].id) {
                    const product = allProducts.find(p => p.id === recs[category].id);
                    if (product) {
                        content.innerHTML += `
                            <div class="bg-slate-800/50 p-4 rounded-lg">
                                <h3 class="font-bold text-lg text-secondary-color">${category.charAt(0).toUpperCase() + category.slice(1)} Recommendation</h3>
                                <div class="flex gap-4 mt-2">
                                    <img src="${product.images[0]}" class="w-24 h-24 object-contain bg-slate-900 rounded-md">
                                    <div>
                                        <h4 class="font-semibold">${product.name}</h4>
                                        <p class="text-sm text-slate-300 mt-1">${recs[category].reason}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }
            });
            content.innerHTML += `<div class="mt-4 p-4 bg-slate-800 rounded-lg"><h3 class="font-bold text-primary-color">Overall Summary</h3><p class="text-sm text-slate-300 mt-1">${recs.summary}</p></div>`;
        }

      // --- EVENT LISTENERS ---
      document.getElementById('category-nav').addEventListener('click', e => {
          e.preventDefault();
          const target = e.target.closest('a');
          if (target && target.dataset.category) {
              applyFiltersAndSort(target.dataset.category);
              document.querySelectorAll('#category-nav a').forEach(a => a.classList.remove('bg-blue-500/20', 'text-blue-400'));
              target.classList.add('bg-blue-500/20', 'text-blue-400');
          }
      });
      productsGrid.addEventListener('click', e => {
          const card = e.target.closest('.product-card');
          if (!card) return;
          const productId = card.dataset.productId;

          if (e.target.closest('.compare-btn')) {
              toggleCompare(productId);
          } else if (e.target.closest('.wishlist-btn')) {
              toggleWishlist(productId);
          } else {
              openProductOverlay(productId);
          }
      });
      searchInput.addEventListener('input', () => applyFiltersAndSort(document.querySelector('#category-nav a.bg-blue-500\/20')?.dataset.category || 'All Products'));
      sortFilter.addEventListener('change', () => applyFiltersAndSort(document.querySelector('#category-nav a.bg-blue-500\/20')?.dataset.category || 'All Products'));
      
      document.getElementById('product-overlay').addEventListener('click', (e) => {
        if(e.target === document.getElementById('product-overlay')) {
            document.getElementById('product-overlay').classList.remove('visible');
        }
      });
      document.getElementById('close-product-overlay').addEventListener('click', () => document.getElementById('product-overlay').classList.remove('visible'));


      document.getElementById('thumbnail-container').addEventListener('click', e => {
        if (e.target.tagName === 'IMG') {
            const mainImage = document.getElementById('product-image');
            mainImage.src = e.target.src;
            document.querySelectorAll('#thumbnail-container img').forEach(img => img.classList.replace('border-blue-500', 'border-transparent'));
            e.target.classList.replace('border-transparent', 'border-blue-500');
        }
      });
      
      document.getElementById('product-detail-content').addEventListener('click', e => {
          if (e.target && e.target.id === 'generate-persona-review-btn') {
              getAIPersonaReview(e.target.dataset.productId);
          }
      });
      
      // Comparison Listeners
      document.getElementById('clear-comparison-btn').addEventListener('click', () => {
          comparisonList = [];
          updateComparisonTray();
      });
      document.getElementById('compare-now-btn').addEventListener('click', getAIComparison);
      
      // Wishlist Menu Listeners
      document.getElementById('wishlist-btn').addEventListener('click', () => {
          renderWishlistMenu();
          document.getElementById('wishlist-menu').classList.toggle('hidden');
      });
      document.getElementById('wishlist-menu').addEventListener('click', e => {
          if (e.target.closest('.remove-wishlist-item-btn')) {
              toggleWishlist(e.target.closest('.remove-wishlist-item-btn').dataset.id);
          }
          if (e.target.id === 'wishlist-clear') {
              wishlist = [];
              saveAndNotify("Wishlist cleared.");
          }
          if (e.target.id === 'wishlist-add-all-to-cart') {
              wishlist.forEach(id => addToCart(id));
              wishlist = [];
              saveAndNotify("All wishlist items added to cart.");
          }
          if (e.target.id === 'wishlist-buy-all') {
              const itemsToBuy = wishlist.map(id => {
                  const product = allProducts.find(p=>p.id === id);
                  return { name: product.name, price: product.salePrice || product.price, quantity: 1 };
              });
              localStorage.setItem('buyNowProduct', JSON.stringify(itemsToBuy));
              window.location.href = 'address.html';
          }
      });
      
      
      // Close Modals Listeners
      modals.forEach(modal => {
          modal.addEventListener('click', (e) => {
              if (e.target === modal) {
                  modal.classList.remove('visible');
              }
          })
      });
      document.getElementById('close-comparison-modal').addEventListener('click', () => document.getElementById('comparison-modal-overlay').classList.remove('visible'));
      document.getElementById('close-setup-builder-modal').addEventListener('click', () => document.getElementById('setup-builder-overlay').classList.remove('visible'));

      // AI Setup Builder Listeners
      document.getElementById('open-setup-builder-btn').addEventListener('click', () => {
          document.getElementById('setup-builder-overlay').classList.add('visible');
      });
      document.getElementById('setup-builder-form').addEventListener('submit', handleSetupBuilderSubmit);
      document.getElementById('restart-setup-builder-btn').addEventListener('click', () => {
          document.getElementById('setup-builder-form-container').style.display = 'block';
          document.getElementById('setup-builder-result').style.display = 'none';
      });


      document.getElementById('hamburger').addEventListener('click', () => document.querySelector('.sidebar').classList.toggle('-translate-x-full'));
      document.getElementById('category-toggle').addEventListener('click', () => document.getElementById('category-menu').classList.toggle('translate-x-full'));

      initializeApp();
    });
  </script>
</body>
</html>
